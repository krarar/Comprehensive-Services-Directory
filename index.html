<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="theme-color" content="#5B2FD4">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="دليل الخدمات">
<meta name="description" content="دليلك الشامل لأفضل الخدمات">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<link rel="apple-touch-startup-image" href="apple-touch-icon.png">
<meta name="msapplication-TileImage" content="icons/icon-144.png">
<meta name="msapplication-TileColor" content="#5B2FD4">
<link rel="icon" type="image/x-icon" href="icons/favicon.ico">
<title>دليل الخدمات</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
:root{
  --P:#5B2FD4;--PL:#7C52F0;--PD:#3D1FA8;
  --A:#FF6B35;--AL:#FF8C5A;
  --S:#10b981;--W:#F59E0B;--R:#EF4444;
  --BG:#F0EEFF;--BG2:#E6E0FF;--BG3:#FAF8FF;
  --SRF:#fff;--BDR:#DDD5FF;
  --T:#120E2E;--T2:#5B4FA0;--T3:#A89DC8;
  --SH1:0 1px 8px rgba(91,47,212,.09);
  --SH2:0 4px 20px rgba(91,47,212,.15);
  --SH3:0 16px 48px rgba(91,47,212,.22);
  --RX:12px;--RXL:18px;
  --NH:56px;--HH:52px;
  --TR:.25s cubic-bezier(.4,0,.2,1);
  --fs-xs:10px;--fs-sm:12px;--fs-base:13px;--fs-md:14px;--fs-lg:15px;--fs-xl:17px;--fs-2xl:20px;
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html{font-size:14px;-webkit-text-size-adjust:100%}
body{font-family:'Tajawal',sans-serif;background:var(--BG);color:var(--T);min-height:100%;-webkit-font-smoothing:antialiased;overflow-x:hidden;padding-bottom:calc(var(--NH)+env(safe-area-inset-bottom))}
a{text-decoration:none;color:inherit}
button{font-family:'Tajawal',sans-serif;cursor:pointer;border:none;background:none}
input,textarea,select{font-family:'Tajawal',sans-serif;font-size:14px}
img{max-width:100%;display:block}
::-webkit-scrollbar{width:2px;height:2px}
::-webkit-scrollbar-thumb{background:var(--BDR);border-radius:4px}

/* ANIMATIONS */
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
@keyframes scaleIn{from{opacity:0;transform:scale(.88)}to{opacity:1;transform:scale(1)}}
@keyframes popIn{0%{transform:scale(0) rotate(-8deg);opacity:0}75%{transform:scale(1.05)}100%{transform:scale(1);opacity:1}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
@keyframes heartBeat{0%,100%{transform:scale(1)}25%{transform:scale(1.25)}50%{transform:scale(1.05)}75%{transform:scale(1.15)}}
@keyframes gradMove{0%{background-position:0 50%}50%{background-position:100% 50%}100%{background-position:0 50%}}
@keyframes bounceDot{0%,80%,100%{transform:scale(0)}40%{transform:scale(1)}}
@keyframes ringDraw{from{stroke-dashoffset:283}to{stroke-dashoffset:0}}
@keyframes waveHand{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-18deg)}40%,80%{transform:rotate(18deg)}}
@keyframes adIn{from{opacity:0;transform:scale(.92) translateY(20px)}to{opacity:1;transform:scale(1) translateY(0)}}
@keyframes fabPop{0%{transform:scale(0) rotate(-180deg)}100%{transform:scale(1) rotate(0)}}
@keyframes postIn{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}
@keyframes sheetUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
@keyframes viewIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}
@keyframes chatMsgIn{from{opacity:0;transform:scale(.95) translateY(6px)}to{opacity:1;transform:scale(1) translateY(0)}}
@keyframes typing{0%,80%,100%{transform:scale(0)}40%{transform:scale(1)}}
@keyframes locPulse{0%{transform:scale(1);opacity:.8}100%{transform:scale(2);opacity:0}}

/* SPLASH */
#splash{position:fixed;inset:0;z-index:9999;background:linear-gradient(145deg,#3D1FA8,#5B2FD4,#7C52F0,#FF6B35);background-size:300% 300%;animation:gradMove 4s ease infinite;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity .5s,visibility .5s;overflow:hidden}
#splash.hide{opacity:0;visibility:hidden;pointer-events:none}
.sc{position:absolute;border-radius:50%;background:rgba(255,255,255,.05)}
.sc:nth-child(1){width:260px;height:260px;top:-60px;right:-60px;animation:float 6s ease-in-out infinite}
.sc:nth-child(2){width:180px;height:180px;bottom:-40px;left:-40px;animation:float 7s ease-in-out infinite reverse}
.sc:nth-child(3){width:100px;height:100px;top:38%;left:12%;animation:float 5s ease-in-out infinite 1s}
.spl-ring{position:relative;width:90px;height:90px;animation:popIn .7s cubic-bezier(.34,1.56,.64,1) .3s both}
.spl-ring svg{position:absolute;inset:0;width:100%;height:100%}
.rp{animation:ringDraw 1.5s ease 1s both}
.spl-in{position:absolute;inset:10px;border-radius:50%;background:rgba(255,255,255,.15);backdrop-filter:blur(6px);display:flex;align-items:center;justify-content:center;font-size:32px;color:white;animation:pulse 2s ease-in-out 1.5s infinite}
.spl-t{font-size:26px;font-weight:900;color:white;margin-top:18px;animation:slideUp .5s ease .8s both;text-shadow:0 2px 16px rgba(0,0,0,.2)}
.spl-s{font-size:13px;color:rgba(255,255,255,.72);margin-top:6px;animation:slideUp .5s ease 1s both}
.spl-dots{display:flex;gap:7px;margin-top:28px;animation:fadeIn .4s ease 1.2s both}
.spl-d{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.45);animation:bounceDot 1.4s ease-in-out 1.4s infinite}
.spl-d:nth-child(2){animation-delay:1.6s}.spl-d:nth-child(3){animation-delay:1.8s}

/* AUTH */
#auth-wrap{position:fixed;inset:0;z-index:8000;background:var(--BG);overflow-y:auto;display:none;flex-direction:column}
#auth-wrap.on{display:flex}
.asc{display:none;flex-direction:column;min-height:100vh}
.asc.on{display:flex}
.ah{background:linear-gradient(155deg,var(--PD),var(--P),var(--PL));padding:env(safe-area-inset-top,14px) 18px 32px;padding-top:calc(env(safe-area-inset-top) + 36px);position:relative;overflow:hidden;flex-shrink:0}
.ah::before{content:'';position:absolute;top:-50px;left:-50px;width:190px;height:190px;border-radius:50%;background:rgba(255,255,255,.05)}
.ah::after{content:'';position:absolute;bottom:-70px;right:-35px;width:180px;height:180px;border-radius:50%;background:rgba(255,107,53,.12)}
.ah-ico{width:58px;height:58px;border-radius:17px;background:rgba(255,255,255,.16);backdrop-filter:blur(6px);display:flex;align-items:center;justify-content:center;font-size:26px;color:white;margin-bottom:14px;box-shadow:0 6px 20px rgba(0,0,0,.18);animation:popIn .5s cubic-bezier(.34,1.56,.64,1) .2s both}
.ah-tit{font-size:22px;font-weight:900;color:white;margin-bottom:4px;animation:slideUp .5s ease .3s both}
.ah-sub{font-size:13px;color:rgba(255,255,255,.72);animation:slideUp .5s ease .4s both;line-height:1.5}
.ab{flex:1;background:var(--BG3);border-radius:22px 22px 0 0;margin-top:-16px;padding:20px 16px 36px;position:relative;z-index:1;box-shadow:0 -6px 24px rgba(91,47,212,.08)}
.ab h2{font-size:17px;font-weight:900;color:var(--T);margin-bottom:16px;display:flex;align-items:center;gap:8px}
.ab h2 i{color:var(--P);font-size:16px}

/* FORM */
.fg{margin-bottom:12px}
.fl{font-size:12px;font-weight:700;color:var(--T2);margin-bottom:5px;display:block}
.fw{position:relative}
.fi{position:absolute;top:50%;transform:translateY(-50%);right:12px;color:var(--T3);font-size:14px;pointer-events:none;transition:color var(--TR)}
.fw:focus-within .fi{color:var(--P)}
.finp{width:100%;height:46px;border-radius:12px;border:2px solid var(--BDR);padding:0 38px;font-size:14px;background:var(--SRF);color:var(--T);transition:var(--TR);outline:none;box-shadow:var(--SH1)}
.finp:focus{border-color:var(--P);box-shadow:0 0 0 3px rgba(91,47,212,.08)}
.finp.e{border-color:var(--R);background:#FFF5F5}
.ftgl{position:absolute;top:50%;transform:translateY(-50%);left:11px;color:var(--T3);font-size:14px;cursor:pointer;background:none;border:none;padding:4px;transition:color var(--TR)}
.fsel{width:100%;height:46px;border-radius:12px;border:2px solid var(--BDR);padding:0 38px;font-size:13px;background:var(--SRF);color:var(--T);transition:var(--TR);outline:none;appearance:none;cursor:pointer}
.fsel:focus{border-color:var(--P);box-shadow:0 0 0 3px rgba(91,47,212,.08)}
.ftxt{width:100%;border-radius:12px;border:2px solid var(--BDR);padding:10px 38px 10px 12px;font-size:13px;background:var(--SRF);color:var(--T);transition:var(--TR);outline:none;resize:vertical;line-height:1.5}
.ftxt:focus{border-color:var(--P);box-shadow:0 0 0 3px rgba(91,47,212,.08)}
.fe{font-size:11px;color:var(--R);margin-top:4px;display:none;align-items:center;gap:3px}
.fe.on{display:flex}.fe i{font-size:10px}

/* Location box */
.loc-box{background:var(--BG2);border:2px solid var(--BDR);border-radius:12px;padding:10px 13px;margin-bottom:12px;cursor:pointer;transition:var(--TR)}
.loc-box:hover{border-color:var(--P)}
.loc-row{display:flex;align-items:center;gap:10px}
.loc-ico{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--P),var(--PL));display:flex;align-items:center;justify-content:center;font-size:16px;color:white;flex-shrink:0;position:relative}
.loc-pulse{position:absolute;inset:-3px;border-radius:50%;border:2px solid var(--P);animation:locPulse 1.5s ease infinite}
.loc-txt{flex:1;min-width:0}
.loc-lbl{font-size:12px;font-weight:700;color:var(--T)}
.loc-val{font-size:11px;color:var(--T3);margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.loc-act{font-size:11px;color:var(--P);font-weight:700;flex-shrink:0}

/* PW STRENGTH */
.pw-bars{display:flex;gap:3px;margin:6px 0 3px}
.pb{flex:1;height:3px;border-radius:3px;background:var(--BDR);transition:background .3s}
.pb.w{background:var(--R)}.pb.m{background:var(--W)}.pb.s{background:var(--S)}

/* TERMS */
.tr-row{display:flex;align-items:flex-start;gap:10px;padding:11px;background:var(--BG2);border-radius:10px;margin-bottom:12px;border:2px solid transparent;cursor:pointer;transition:var(--TR)}
.tr-row.ck{border-color:var(--P);background:rgba(91,47,212,.05)}
.tr-cb{width:20px;height:20px;border-radius:6px;border:2px solid var(--BDR);display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:var(--TR);margin-top:1px}
.tr-row.ck .tr-cb{background:var(--P);border-color:var(--P)}
.tr-cb i{font-size:10px;color:white;opacity:0;transition:var(--TR)}
.tr-row.ck .tr-cb i{opacity:1}
.tr-txt{font-size:12px;color:var(--T2);line-height:1.5}
.tr-lnk{color:var(--P);font-weight:700;cursor:pointer}

/* BUTTONS */
.btn-p{width:100%;height:48px;border-radius:14px;background:linear-gradient(135deg,var(--P),var(--PL));color:white;font-size:15px;font-weight:900;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;box-shadow:0 6px 18px rgba(91,47,212,.3);transition:var(--TR);margin-bottom:10px}
.btn-p:active{transform:scale(.97)}.btn-p.ld{pointer-events:none;opacity:.8}
.btn-s{width:100%;height:44px;border-radius:14px;background:transparent;color:var(--P);font-size:14px;font-weight:700;border:2px solid var(--BDR);cursor:pointer;display:flex;align-items:center;justify-content:center;gap:7px;transition:var(--TR)}
.btn-s:active{background:var(--BG2)}
.btn-wa{width:100%;height:48px;border-radius:14px;background:linear-gradient(135deg,#1A9E50,#25D366);color:white;font-size:14px;font-weight:900;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;box-shadow:0 6px 18px rgba(37,211,102,.25);transition:var(--TR);margin-bottom:10px}
.btn-wa:active{transform:scale(.97)}
.auth-sw{text-align:center;font-size:13px;color:var(--T3);margin-top:6px}
.auth-sw span{color:var(--P);font-weight:700;cursor:pointer}

/* STEPS */
.steps{display:flex;align-items:center;justify-content:center;gap:0;margin-bottom:18px}
.step{display:flex;flex-direction:column;align-items:center}
.step-c{width:28px;height:28px;border-radius:50%;border:2px solid var(--BDR);background:var(--SRF);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:var(--T3);transition:var(--TR)}
.step.done .step-c{background:var(--S);border-color:var(--S);color:white}
.step.active .step-c{background:var(--P);border-color:var(--P);color:white;box-shadow:0 0 0 3px rgba(91,47,212,.13)}
.step-ln{width:30px;height:2px;background:var(--BDR);margin:0 3px;margin-bottom:12px;transition:var(--TR)}
.step.done+.step-ln{background:var(--S)}
.step-lb{font-size:9px;color:var(--T3);margin-top:3px;font-weight:600}
.step.active .step-lb,.step.done .step-lb{color:var(--P)}

/* OTP */
.otp-desc{font-size:12px;color:var(--T2);line-height:1.6;text-align:center;margin-bottom:18px;background:var(--BG2);padding:11px;border-radius:10px}
.otp-desc strong{color:var(--P)}
.otp-row{display:flex;justify-content:center;gap:6px;margin-bottom:12px}
.oi{width:44px;height:52px;border-radius:12px;border:2px solid var(--BDR);background:var(--SRF);font-size:22px;font-weight:900;color:var(--P);text-align:center;outline:none;transition:var(--TR)}
.oi:focus{border-color:var(--P);box-shadow:0 0 0 3px rgba(91,47,212,.1)}
.oi.f{border-color:var(--P);background:rgba(91,47,212,.04)}

/* TERMS MODAL */
#tmod{position:fixed;inset:0;z-index:9500;background:rgba(18,14,46,.65);backdrop-filter:blur(4px);display:none;align-items:flex-end;justify-content:center;padding-bottom:env(safe-area-inset-bottom)}
#tmod.on{display:flex;animation:fadeIn .3s ease}
.tbox{background:var(--SRF);border-radius:20px 20px 0 0;width:100%;max-width:600px;max-height:85vh;display:flex;flex-direction:column;animation:sheetUp .3s cubic-bezier(.4,0,.2,1)}
.thdr{display:flex;justify-content:space-between;align-items:center;padding:14px 16px 11px;border-bottom:1px solid var(--BDR);flex-shrink:0}
.thdr h3{font-size:15px;font-weight:900;color:var(--T)}
.tcls{width:28px;height:28px;border-radius:9px;background:var(--BG2);display:flex;align-items:center;justify-content:center;color:var(--T2);cursor:pointer;border:none;font-size:12px}
.tbody{flex:1;overflow-y:auto;padding:14px 16px}
.ts{margin-bottom:14px}.ts h4{font-size:13px;font-weight:900;color:var(--P);margin-bottom:5px;display:flex;align-items:center;gap:7px}
.ts p{font-size:12px;color:var(--T2);line-height:1.65}
.tftr{padding:12px 16px;border-top:1px solid var(--BDR);flex-shrink:0}

/* HEADER */
#hdr{position:fixed;top:0;right:0;left:0;z-index:500;height:calc(var(--HH) + env(safe-area-inset-top,0px));min-height:var(--HH);background:var(--P);display:flex;align-items:center;justify-content:space-between;padding:0 12px;padding-top:env(safe-area-inset-top,0px);box-shadow:0 2px 14px rgba(91,47,212,.28)}

.hlogo{display:flex;align-items:center;gap:7px;font-size:15px;font-weight:900;color:white}
.hlogo i{font-size:17px}
.hacts{display:flex;align-items:center;gap:5px}
.hbtn{width:34px;height:34px;border-radius:10px;background:rgba(255,255,255,.14);border:none;cursor:pointer;color:white;font-size:14px;display:flex;align-items:center;justify-content:center;transition:var(--TR);position:relative}
.hbtn:active{transform:scale(.9);background:rgba(255,255,255,.24)}
.hbadge{position:absolute;top:3px;right:3px;min-width:14px;height:14px;border-radius:7px;background:var(--R);color:white;font-size:9px;font-weight:900;display:flex;align-items:center;justify-content:center;border:2px solid var(--P);padding:0 2px}
#hback{display:none;align-items:center;justify-content:center}
#hback.on{display:flex}
#htit{font-size:13px;font-weight:700;color:white;position:absolute;left:50%;transform:translateX(-50%);white-space:nowrap;max-width:160px;overflow:hidden;text-overflow:ellipsis}
.hav{width:32px;height:32px;border-radius:10px;background:rgba(255,255,255,.18);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:900;color:white;cursor:pointer;overflow:hidden;transition:var(--TR)}
.hav:active{transform:scale(.9)}

/* MAIN */
#main{padding-top:calc(var(--HH) + env(safe-area-inset-top,0px));min-height:100vh}
.view{display:none}.view.on{display:block;animation:viewIn .28s ease}

/* HOME */
.hhero{background:linear-gradient(150deg,var(--PD),var(--P),var(--PL));padding:16px 14px 52px;position:relative;overflow:hidden}
.hhero::before{content:'';position:absolute;top:-40px;left:-40px;width:170px;height:170px;border-radius:50%;background:rgba(255,255,255,.04)}
.hhero::after{content:'';position:absolute;bottom:-50px;right:-25px;width:140px;height:140px;border-radius:50%;background:rgba(255,107,53,.12)}
.hw{position:absolute;bottom:0;left:0;right:0;height:38px}.hw svg{width:100%;height:100%}
.hgreet{font-size:12px;color:rgba(255,255,255,.68);font-weight:500;margin-bottom:2px;display:flex;align-items:center;gap:5px}
.hname{font-size:18px;font-weight:900;color:white;margin-bottom:12px;line-height:1.3}
.hname span{color:#FFD93D}
.sb{position:relative;z-index:1}
.sb input{width:100%;height:44px;border-radius:13px;border:none;padding:0 46px 0 14px;font-size:13px;background:white;color:var(--T);box-shadow:0 6px 20px rgba(0,0,0,.13)}
.sb .sico{position:absolute;top:50%;right:14px;transform:translateY(-50%);font-size:15px;color:var(--P);pointer-events:none}
.stats-row{display:flex;justify-content:space-around;padding:10px 14px;background:var(--SRF);box-shadow:var(--SH1)}
.stat{text-align:center}.stn{font-size:17px;font-weight:900;color:var(--P)}.stl{font-size:10px;color:var(--T3);font-weight:600}
.sec{padding:12px 13px 0}.sechdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.secttl{font-size:14px;font-weight:900;color:var(--T)}
.secmore{font-size:12px;color:var(--P);font-weight:700;cursor:pointer;display:flex;align-items:center;gap:3px}
.cgrid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;padding-bottom:4px}
.ctile{background:var(--SRF);border-radius:var(--RX);padding:10px 5px;display:flex;flex-direction:column;align-items:center;gap:5px;cursor:pointer;border:none;box-shadow:var(--SH1);transition:var(--TR);position:relative;overflow:hidden;animation:scaleIn .4s cubic-bezier(.34,1.56,.64,1) both}
.ctile:active{transform:scale(.92)}
.cico{width:40px;height:40px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:17px;color:white;box-shadow:0 3px 10px rgba(0,0,0,.15);transition:var(--TR)}
.ctile:active .cico{transform:scale(1.08) rotate(-5deg)}
.clbl{font-size:9px;font-weight:700;color:var(--T);text-align:center;line-height:1.2}
.ccount{font-size:8px;color:var(--T3);font-weight:600;background:var(--BG2);border-radius:8px;padding:1px 5px}
.fsc{display:flex;gap:10px;padding:0 13px 13px;overflow-x:auto;scroll-snap-type:x mandatory;scrollbar-width:none;-webkit-overflow-scrolling:touch}
.fsc::-webkit-scrollbar{display:none}
.fcard{min-width:155px;border-radius:var(--RXL);background:var(--SRF);box-shadow:var(--SH1);overflow:hidden;cursor:pointer;transition:var(--TR);scroll-snap-align:start;flex-shrink:0;border:1px solid var(--BDR)}
.fcard:active{transform:scale(.96)}
.fimg{width:100%;height:96px;object-fit:cover;background:var(--BG2)}
.fph{width:100%;height:96px;display:flex;align-items:center;justify-content:center;font-size:32px;color:rgba(255,255,255,.8)}
.fbdy{padding:8px 10px 12px}
.fnm{font-size:12px;font-weight:700;color:var(--T);margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.fadr{font-size:10px;color:var(--T3)}
.fbdg{display:inline-flex;align-items:center;gap:3px;background:#FFF5F0;color:var(--A);font-size:9px;font-weight:700;padding:2px 7px;border-radius:20px;margin-top:4px}
.bad{margin:0 12px 12px;border-radius:var(--RX);background:linear-gradient(135deg,#FFF8E6,#FFF3CC);border:1px solid #FFD93D;padding:10px 12px;display:flex;align-items:center;gap:10px;cursor:pointer}
.bad:active{transform:scale(.98)}
.badico{width:38px;height:38px;border-radius:10px;background:linear-gradient(135deg,#F59E0B,#FBBF24);display:flex;align-items:center;justify-content:center;font-size:17px;color:white;flex-shrink:0}
.badtxt{flex:1}.badtit{font-size:12px;font-weight:900;color:#92400E}.badsub{font-size:10px;color:#B45309;margin-top:1px}
.badcta{font-size:11px;font-weight:700;color:white;background:linear-gradient(135deg,#F59E0B,#D97706);padding:5px 10px;border-radius:7px;white-space:nowrap}

/* LIST */
.lbar{background:var(--SRF);padding:8px 12px;border-bottom:1px solid var(--BDR);position:sticky;top:calc(var(--HH) + env(safe-area-inset-top,0px));z-index:100}
.lbrow{display:flex;gap:6px;align-items:center}
.liwrap{position:relative;flex:1}
.liwrap i{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--T3);font-size:12px;pointer-events:none}
.li{width:100%;height:38px;border-radius:10px;border:2px solid var(--BDR);padding:0 11px 0 32px;font-size:13px;background:var(--BG);color:var(--T);transition:var(--TR);outline:none}
.li:focus{border-color:var(--P);background:white}
.lsel{height:38px;border-radius:10px;border:2px solid var(--BDR);padding:0 8px;font-size:12px;background:var(--BG);color:var(--T);cursor:pointer;outline:none;appearance:none}

/* User cards */
.ugrid{display:grid;grid-template-columns:1fr;gap:10px;padding:12px}
.ucard{background:var(--SRF);border-radius:var(--RXL);box-shadow:var(--SH1);border:1px solid var(--BDR);overflow:hidden;cursor:pointer;transition:var(--TR);animation:slideUp .35s ease both;display:flex;align-items:center;padding:11px 12px;gap:11px}
.ucard:active{transform:scale(.98)}
.ucav{width:50px;height:50px;border-radius:15px;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:900;color:white;flex-shrink:0}
.uc-info{flex:1;min-width:0}
.uc-nm{font-size:13px;font-weight:900;color:var(--T);margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.uc-type{display:inline-flex;align-items:center;gap:3px;background:var(--BG2);color:var(--P);font-size:10px;font-weight:700;padding:2px 7px;border-radius:20px;margin-bottom:3px}
.uc-adr{font-size:11px;color:var(--T3);display:flex;align-items:center;gap:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.uc-bio{font-size:10px;color:var(--T3);margin-top:2px;overflow:hidden;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical}
.uc-actions{display:flex;flex-direction:column;gap:5px;flex-shrink:0}
.uc-act-btn{width:34px;height:34px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:14px;color:white;border:none;cursor:pointer;transition:var(--TR)}
.uc-act-btn:active{transform:scale(.9)}
.uab-chat{background:linear-gradient(135deg,var(--P),var(--PL))}
.uab-wa{background:linear-gradient(135deg,#1A9E50,#25D366)}
.uab-call{background:linear-gradient(135deg,var(--A),var(--AL))}

/* ITEM GRID */
.igrid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;padding:12px}
.icard{background:var(--SRF);border-radius:var(--RXL);overflow:hidden;box-shadow:var(--SH1);cursor:pointer;transition:var(--TR);border:1px solid var(--BDR);animation:scaleIn .35s ease both}
.icard:active{transform:scale(.96)}
.icimg{width:100%;height:114px;object-fit:cover;background:var(--BG2)}
.icph{width:100%;height:114px;display:flex;align-items:center;justify-content:center;font-size:36px;color:rgba(255,255,255,.8)}
.icbdy{padding:8px 10px 11px}
.icnm{font-size:12px;font-weight:700;color:var(--T);margin-bottom:3px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.icadr{font-size:10px;color:var(--T3);display:flex;align-items:center;gap:2px}
.icadr i{color:var(--P);font-size:9px;flex-shrink:0}
.icfoot{display:flex;align-items:center;justify-content:space-between;margin-top:6px;padding-top:6px;border-top:1px solid var(--BDR)}
.icbdg{display:inline-flex;align-items:center;gap:2px;background:var(--BG2);color:var(--P);font-size:9px;font-weight:700;padding:2px 7px;border-radius:20px}
.favbtn{position:absolute;top:6px;right:6px;width:26px;height:26px;border-radius:8px;background:rgba(255,255,255,.9);backdrop-filter:blur(3px);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--T3);transition:var(--TR)}
.favbtn.on{color:#EF4444;animation:heartBeat .35s ease}

/* DETAIL */
.dhero{position:relative;width:100%;height:210px;overflow:hidden}
.dhero img,.dheroph{width:100%;height:100%;object-fit:cover}
.dheroph{display:flex;align-items:center;justify-content:center;font-size:64px;color:rgba(255,255,255,.7)}
.dhero::after{content:'';position:absolute;bottom:0;left:0;right:0;height:80px;background:linear-gradient(transparent,var(--BG))}
.dbody{padding:0 13px 20px;margin-top:-12px;position:relative;z-index:1}
.dcard{background:var(--SRF);border-radius:var(--RXL);padding:16px;margin-bottom:12px;box-shadow:var(--SH2);border:1px solid var(--BDR);animation:slideUp .35s ease}
.dnm{font-size:19px;font-weight:900;color:var(--T);margin-bottom:8px}
.drow{display:flex;align-items:flex-start;gap:8px;font-size:12px;color:var(--T2);margin-bottom:6px}
.drow i{color:var(--P);width:16px;text-align:center;flex-shrink:0;margin-top:1px}
.ddesc{font-size:12px;color:var(--T2);line-height:1.65;padding-top:10px;margin-top:10px;border-top:1px solid var(--BDR)}
.socrow{display:flex;gap:6px;margin-top:12px;flex-wrap:wrap}
.socbtn{flex:1;min-width:70px;height:38px;border-radius:10px;border:none;cursor:pointer;font-family:'Tajawal',sans-serif;font-size:12px;font-weight:700;display:flex;align-items:center;justify-content:center;gap:5px;transition:var(--TR);text-decoration:none}
.socbtn:active{transform:scale(.94)}
.swa{background:#25D366;color:white}.sfb{background:#1877F2;color:white}.sig{background:linear-gradient(135deg,#f09433,#dc2743,#bc1888);color:white}.sph{background:var(--P);color:white}
.bkcard{background:var(--SRF);border-radius:var(--RXL);padding:16px;box-shadow:var(--SH1);border:1px solid var(--BDR)}
.bktit{font-size:15px;font-weight:900;color:var(--T);margin-bottom:13px;display:flex;align-items:center;gap:7px}
.bktit i{color:var(--P)}
.btnbk{width:100%;height:46px;border-radius:13px;border:none;cursor:pointer;font-family:'Tajawal',sans-serif;font-size:14px;font-weight:900;background:linear-gradient(135deg,var(--A),var(--AL));color:white;box-shadow:0 6px 18px rgba(255,107,53,.26);display:flex;align-items:center;justify-content:center;gap:7px;transition:var(--TR)}
.btnbk:active{transform:scale(.97)}.btnbk.ld{opacity:.8;pointer-events:none}

/* USER PUBLIC PROFILE */
.upphero{position:relative;background:linear-gradient(150deg,var(--PD),var(--P),var(--PL));padding:50px 16px 64px;overflow:hidden;text-align:center}
.upphero::before{content:'';position:absolute;top:-40px;left:-40px;width:170px;height:170px;border-radius:50%;background:rgba(255,255,255,.05)}
.upp-av{width:78px;height:78px;border-radius:24px;margin:0 auto 11px;display:flex;align-items:center;justify-content:center;font-size:28px;font-weight:900;color:white;border:3px solid rgba(255,255,255,.35);box-shadow:0 6px 20px rgba(0,0,0,.18);position:relative;z-index:1}
.upp-nm{font-size:17px;font-weight:900;color:white;position:relative;z-index:1}
.upp-type{display:inline-flex;align-items:center;gap:5px;background:rgba(255,255,255,.18);backdrop-filter:blur(4px);padding:3px 12px;border-radius:20px;font-size:12px;color:rgba(255,255,255,.9);font-weight:600;position:relative;z-index:1;margin-top:5px}
.upp-loc{font-size:11px;color:rgba(255,255,255,.65);margin-top:5px;position:relative;z-index:1;display:flex;align-items:center;justify-content:center;gap:4px}
.upp-actions{display:flex;gap:8px;justify-content:center;margin-top:13px;position:relative;z-index:1;flex-wrap:wrap}
.upp-act{padding:8px 14px;border-radius:12px;border:none;cursor:pointer;font-family:'Tajawal',sans-serif;font-size:12px;font-weight:900;display:flex;align-items:center;gap:6px;transition:var(--TR)}
.upp-act:active{transform:scale(.94)}
.uppa-chat{background:white;color:var(--P)}
.uppa-wa,.uppa-call{background:rgba(255,255,255,.18);backdrop-filter:blur(4px);color:white;border:1px solid rgba(255,255,255,.28)}
.upp-body{padding:11px}
.upp-stat-bar{display:flex;justify-content:space-around;background:var(--SRF);border-radius:var(--RXL);padding:12px 8px;margin-bottom:12px;box-shadow:var(--SH1);border:1px solid var(--BDR)}
.upp-stn{font-size:16px;font-weight:900;color:var(--P)}
.upp-stl{font-size:10px;color:var(--T3);font-weight:600}

/* FEED */
.feed-top{background:linear-gradient(135deg,var(--P),var(--PL));padding:16px 13px 22px;position:relative;overflow:hidden}
.feed-top::after{content:'';position:absolute;bottom:-12px;left:0;right:0;height:24px;background:var(--BG);border-radius:12px 12px 0 0}
.feed-filters{display:flex;gap:6px;overflow-x:auto;padding:13px 13px 0;scrollbar-width:none}
.feed-filters::-webkit-scrollbar{display:none}
.ffbtn{height:30px;border-radius:20px;padding:0 11px;border:2px solid var(--BDR);background:var(--SRF);font-family:'Tajawal',sans-serif;font-size:12px;font-weight:700;color:var(--T2);cursor:pointer;transition:var(--TR);white-space:nowrap;flex-shrink:0}
.ffbtn.on{background:var(--P);border-color:var(--P);color:white;box-shadow:0 3px 10px rgba(91,47,212,.27)}
.ap-type-row{display:flex;gap:7px;padding:0 13px 10px}
.pt-tab{flex:1;height:34px;border-radius:10px;border:2px solid var(--BDR);background:var(--SRF);font-family:'Tajawal',sans-serif;font-size:12px;font-weight:700;color:var(--T2);cursor:pointer;display:flex;align-items:center;justify-content:center;gap:5px;transition:var(--TR)}
.pt-tab.on{border-color:var(--P);background:rgba(91,47,212,.07);color:var(--P)}
.feed-list{padding:11px 11px 18px}

/* POST CARD */
.pcard{background:var(--SRF);border-radius:var(--RXL);box-shadow:var(--SH1);border:1px solid var(--BDR);overflow:hidden;margin-bottom:13px;animation:postIn .35s ease both}
.phead{display:flex;align-items:center;gap:10px;padding:11px 12px 0}
.pav{width:40px;height:40px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:900;color:white;flex-shrink:0;cursor:pointer;transition:var(--TR)}
.pav:active{transform:scale(.92)}
.puinfo{flex:1;cursor:pointer}
.punm{font-size:13px;font-weight:900;color:var(--T)}
.pumeta{display:flex;align-items:center;gap:5px;margin-top:1px;flex-wrap:wrap}
.putype{font-size:10px;font-weight:700;color:white;padding:1px 7px;border-radius:20px}
.ptype-badge{font-size:9px;font-weight:700;padding:1px 6px;border-radius:20px}
.ptb-offer{background:#ECFDF5;color:#059669}
.ptb-req{background:#FFF7ED;color:#f59e0b}
.ptime{font-size:10px;color:var(--T3)}
.pmenu{width:28px;height:28px;border-radius:9px;border:none;background:var(--BG2);display:flex;align-items:center;justify-content:center;color:var(--T3);font-size:12px;cursor:pointer}
.pimgs{position:relative;margin-top:10px}
.pimgs-track{display:flex;overflow-x:auto;scroll-snap-type:x mandatory;scrollbar-width:none}
.pimgs-track::-webkit-scrollbar{display:none}
.pslide{min-width:100%;scroll-snap-align:start;flex-shrink:0}
.pslide img{width:100%;height:200px;object-fit:cover;display:block}
.pdots{position:absolute;bottom:7px;left:50%;transform:translateX(-50%);display:flex;gap:4px}
.pdot{width:5px;height:5px;border-radius:50%;background:rgba(255,255,255,.45);transition:var(--TR)}
.pdot.on{background:white;width:14px;border-radius:3px}
.pbody{padding:11px 12px 8px}
.ptit{font-size:14px;font-weight:900;color:var(--T);margin-bottom:5px}
.pcat-tag{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:20px;font-size:10px;font-weight:700;margin-bottom:6px}
.pdesc{font-size:12px;color:var(--T2);line-height:1.6;margin-bottom:7px}
.pinfo-row{display:flex;align-items:center;gap:5px;font-size:11px;color:var(--T3);margin-bottom:3px}
.pinfo-row i{color:var(--P);font-size:10px;width:14px;text-align:center}
.pactions{display:flex;gap:5px;padding:2px 12px 11px;flex-wrap:wrap}
.pabtn{flex:1;min-width:0;height:36px;border-radius:10px;border:none;cursor:pointer;font-family:'Tajawal',sans-serif;font-size:11px;font-weight:700;display:flex;align-items:center;justify-content:center;gap:4px;transition:var(--TR);text-decoration:none;white-space:nowrap}
.pabtn:active{transform:scale(.95)}
.pa-call{background:linear-gradient(135deg,var(--P),var(--PL));color:white}
.pa-wa{background:linear-gradient(135deg,#1A9E50,#25D366);color:white}
.pa-ig{background:linear-gradient(135deg,#f09433,#dc2743,#bc1888);color:white}
.pa-fb{background:linear-gradient(135deg,#1877F2,#3B82F6);color:white}
.pa-chat{background:linear-gradient(135deg,#7C52F0,#5B2FD4);color:white}
.pfoot{display:flex;align-items:center;justify-content:space-between;padding:8px 12px 11px;border-top:1px solid var(--BDR)}
.plike{display:flex;align-items:center;gap:5px;padding:6px 12px;border-radius:20px;border:none;background:var(--BG2);cursor:pointer;font-family:'Tajawal',sans-serif;font-size:12px;font-weight:700;color:var(--T2);transition:var(--TR)}
.plike.on{background:#FFF0F0;color:#EF4444}
.plike:active{transform:scale(.95)}
.plike.on i{animation:heartBeat .35s ease}
.pshr{display:flex;align-items:center;gap:5px;padding:6px 12px;border-radius:20px;border:none;background:var(--BG2);cursor:pointer;font-family:'Tajawal',sans-serif;font-size:12px;font-weight:700;color:var(--T2);transition:var(--TR)}

/* PROFILE */
.phero{background:linear-gradient(135deg,var(--PD),var(--P));padding:22px 16px 68px;text-align:center;position:relative;overflow:hidden}
.pav-lg{width:76px;height:76px;border-radius:22px;background:rgba(255,255,255,.18);backdrop-filter:blur(6px);margin:0 auto 11px;display:flex;align-items:center;justify-content:center;font-size:28px;font-weight:900;color:white;border:3px solid rgba(255,255,255,.35);animation:popIn .5s cubic-bezier(.34,1.56,.64,1) .2s both}
.pnm-lg{font-size:17px;font-weight:900;color:white;margin-bottom:3px}
.ptp-lg{display:inline-flex;align-items:center;gap:5px;background:rgba(255,255,255,.18);font-size:12px;color:rgba(255,255,255,.9);font-weight:600;padding:3px 12px;border-radius:20px;backdrop-filter:blur(4px)}
.pph-lg{font-size:12px;color:rgba(255,255,255,.65);margin-top:5px}
.ploc-bar{font-size:11px;color:rgba(255,255,255,.6);margin-top:4px;display:flex;align-items:center;justify-content:center;gap:4px;cursor:pointer;text-decoration:underline}
.prof-stats{display:flex;justify-content:space-around;background:var(--SRF);margin:0 12px;border-radius:var(--RXL);box-shadow:var(--SH2);padding:12px 8px;margin-top:-32px;position:relative;z-index:1;border:1px solid var(--BDR)}
.pstn{font-size:17px;font-weight:900;color:var(--P)}
.pstl{font-size:10px;color:var(--T3);font-weight:600;margin-top:2px}
.prof-body{padding:11px}
.ptabs{display:flex;gap:0;border-bottom:2px solid var(--BDR);margin-bottom:11px;overflow-x:auto;scrollbar-width:none}
.ptabs::-webkit-scrollbar{display:none}
.ptab{flex-shrink:0;padding:0 10px;height:38px;border:none;background:none;font-family:'Tajawal',sans-serif;font-size:12px;font-weight:700;color:var(--T3);cursor:pointer;transition:var(--TR);position:relative;white-space:nowrap}
.ptab.on{color:var(--P)}
.ptab.on::after{content:'';position:absolute;bottom:-2px;left:0;right:0;height:2px;background:var(--P);border-radius:2px}
.setcard{background:var(--SRF);border-radius:var(--RXL);overflow:hidden;box-shadow:var(--SH1);border:1px solid var(--BDR)}
.setrow{display:flex;align-items:center;gap:11px;padding:12px 13px;border-bottom:1px solid var(--BDR);cursor:pointer;transition:var(--TR)}
.setrow:last-child{border-bottom:none}
.setrow:active{background:var(--BG2)}
.setico{width:34px;height:34px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
.settxt{flex:1}.setlbl{font-size:13px;font-weight:700;color:var(--T)}.setsub{font-size:11px;color:var(--T3);margin-top:1px}
.my-posts-wrap{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
.mpc{position:relative;border-radius:12px;overflow:hidden;cursor:pointer;aspect-ratio:1;background:var(--BG2);animation:scaleIn .35s ease both;transition:var(--TR)}
.mpc:active{transform:scale(.96)}
.mpc img{width:100%;height:100%;object-fit:cover}
.mpc-overlay{position:absolute;inset:0;background:linear-gradient(transparent,rgba(0,0,0,.5));display:flex;align-items:flex-end;padding:8px}
.mpc-title{font-size:11px;font-weight:700;color:white;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}

/* CHAT LIST */
.chat-list{padding:11px}
.chat-item{display:flex;align-items:center;gap:10px;padding:11px 13px;background:var(--SRF);border-radius:var(--RXL);margin-bottom:8px;cursor:pointer;transition:var(--TR);border:1px solid var(--BDR);animation:slideUp .35s ease both}
.chat-item:active{transform:scale(.98)}
.chat-item.unread{border-color:var(--P);background:rgba(91,47,212,.02)}
.ci-av{width:44px;height:44px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:900;color:white;flex-shrink:0;position:relative}
.ci-online{position:absolute;bottom:1px;right:1px;width:11px;height:11px;border-radius:50%;background:#22c55e;border:2px solid white}
.ci-txt{flex:1;min-width:0}
.ci-nm{font-size:13px;font-weight:700;color:var(--T);margin-bottom:2px}
.ci-last{font-size:11px;color:var(--T3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ci-right{display:flex;flex-direction:column;align-items:flex-end;gap:4px;flex-shrink:0}
.ci-time{font-size:10px;color:var(--T3)}
.ci-badge{min-width:18px;height:18px;border-radius:9px;background:var(--P);color:white;font-size:10px;font-weight:900;display:flex;align-items:center;justify-content:center;padding:0 4px}

/* CHAT CONVERSATION */
#chat-conv{position:fixed;inset:0;z-index:700;background:var(--BG);display:none;flex-direction:column;transform:translateX(100%);transition:transform .36s cubic-bezier(.4,0,.2,1)}
#chat-conv.on{display:flex;transform:translateX(0)}
.conv-hdr{background:var(--P);padding:12px 12px;padding-top:calc(env(safe-area-inset-top) + 12px);display:flex;align-items:center;gap:10px;box-shadow:0 3px 16px rgba(91,47,212,.28);flex-shrink:0}
.conv-back{width:34px;height:34px;border-radius:10px;background:rgba(255,255,255,.14);display:flex;align-items:center;justify-content:center;color:white;font-size:16px;cursor:pointer;border:none;flex-shrink:0}
.conv-av{width:38px;height:38px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:900;color:white;flex-shrink:0}
.conv-info{flex:1}
.conv-nm{font-size:13px;font-weight:900;color:white}
.conv-status{font-size:11px;color:rgba(255,255,255,.65)}
.conv-acts{display:flex;gap:6px}
.conv-act{width:32px;height:32px;border-radius:10px;background:rgba(255,255,255,.14);display:flex;align-items:center;justify-content:center;color:white;font-size:14px;cursor:pointer;border:none;transition:var(--TR)}
.conv-act:active{transform:scale(.9)}
.msgs-area{flex:1;overflow-y:auto;padding:13px 12px;display:flex;flex-direction:column;gap:8px}
.msg-row{display:flex;align-items:flex-end;gap:6px;animation:chatMsgIn .28s ease}
.msg-row.mine{flex-direction:row-reverse}
.msg-av-sm{width:26px;height:26px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:900;color:white;flex-shrink:0}
.msg-bubble{max-width:78%;padding:8px 12px;border-radius:16px;position:relative;word-break:break-word}
.msg-row.mine .msg-bubble{background:linear-gradient(135deg,var(--P),var(--PL));color:white;border-bottom-left-radius:5px}
.msg-row.other .msg-bubble{background:var(--SRF);color:var(--T);border-bottom-right-radius:5px;box-shadow:var(--SH1);border:1px solid var(--BDR)}
.msg-txt{font-size:13px;line-height:1.5}
.msg-time{font-size:9px;margin-top:3px;opacity:.7}
.msg-row.mine .msg-time{text-align:right}
.msg-img{width:100%;max-width:200px;border-radius:10px;cursor:pointer;margin-bottom:3px}
.msg-date-sep{text-align:center;font-size:11px;color:var(--T3);font-weight:600;margin:5px 0;position:relative}
.msg-date-sep::before{content:'';position:absolute;top:50%;right:0;left:0;height:1px;background:var(--BDR)}
.msg-date-sep span{background:var(--BG);padding:0 8px;position:relative}
.typing-row{display:flex;align-items:flex-end;gap:6px}
.typing-dots{display:flex;gap:3px;background:var(--SRF);padding:10px 14px;border-radius:16px;border-bottom-right-radius:5px;box-shadow:var(--SH1);border:1px solid var(--BDR)}
.typing-dot{width:6px;height:6px;border-radius:50%;background:var(--T3);animation:typing 1.4s ease-in-out infinite}
.typing-dot:nth-child(2){animation-delay:.2s}.typing-dot:nth-child(3){animation-delay:.4s}
.conv-inp-bar{background:var(--SRF);padding:8px 12px;padding-bottom:calc(8px + env(safe-area-inset-bottom));border-top:1px solid var(--BDR);display:flex;align-items:center;gap:6px;flex-shrink:0}
.conv-inp{flex:1;height:40px;border-radius:20px;border:2px solid var(--BDR);padding:0 14px;font-size:14px;background:var(--BG);color:var(--T);outline:none;transition:var(--TR)}
.conv-inp:focus{border-color:var(--P);background:white}
.conv-send{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,var(--P),var(--PL));border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;color:white;transition:var(--TR);flex-shrink:0}
.conv-send:active{transform:scale(.9)}
.conv-img-btn{width:36px;height:36px;border-radius:10px;background:var(--BG2);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;color:var(--T2)}

/* FAB */
#fab{position:fixed;bottom:calc(var(--NH) + env(safe-area-inset-bottom,0px) + 14px);left:14px;z-index:300;width:50px;height:50px;border-radius:16px;background:linear-gradient(135deg,var(--A),var(--AL));color:white;font-size:20px;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 6px 22px rgba(255,107,53,.4);transition:var(--TR);animation:fabPop .5s cubic-bezier(.34,1.56,.64,1) 1.2s both}
#fab:active{transform:scale(.9)}
#fab.hide{display:none}


/* ADD POST SHEET */
#ap-ov{position:fixed;inset:0;z-index:8000;background:rgba(18,14,46,.62);backdrop-filter:blur(4px);display:none;align-items:flex-end;justify-content:center;padding-bottom:env(safe-area-inset-bottom)}
#ap-ov.on{display:flex;animation:fadeIn .28s ease}
.apsheet{background:var(--SRF);border-radius:22px 22px 0 0;width:100%;max-width:600px;max-height:92vh;display:flex;flex-direction:column;animation:sheetUp .35s cubic-bezier(.4,0,.2,1)}
.ap-handle{width:36px;height:4px;border-radius:4px;background:var(--BDR);margin:10px auto 0;flex-shrink:0}
.aphdr{display:flex;justify-content:space-between;align-items:center;padding:12px 15px 11px;border-bottom:1px solid var(--BDR);flex-shrink:0}
.aphdr h3{font-size:15px;font-weight:900;color:var(--T);display:flex;align-items:center;gap:7px}
.aphdr h3 i{color:var(--P)}
.apx{width:30px;height:30px;border-radius:9px;background:var(--BG2);display:flex;align-items:center;justify-content:center;color:var(--T2);cursor:pointer;border:none;font-size:13px}
.apbody{flex:1;overflow-y:auto;padding:14px}
.ap-type-row-form{display:flex;gap:6px;margin-bottom:13px}
.apt-btn{flex:1;height:36px;border-radius:10px;border:2px solid var(--BDR);background:var(--SRF);font-family:'Tajawal',sans-serif;font-size:12px;font-weight:700;color:var(--T2);cursor:pointer;display:flex;align-items:center;justify-content:center;gap:5px;transition:var(--TR)}
.apt-btn.offer.on{border-color:#059669;background:rgba(5,150,105,.07);color:#059669}
.apt-btn.req.on{border-color:#f59e0b;background:rgba(245,158,11,.07);color:#f59e0b}
.imgu-area{border:2px dashed var(--BDR);border-radius:13px;padding:16px;text-align:center;cursor:pointer;transition:var(--TR);background:var(--BG3);margin-bottom:11px}
.imgu-area:hover,.imgu-area.drag{border-color:var(--P);background:rgba(91,47,212,.03)}
.imgu-area i{font-size:28px;color:var(--T3);margin-bottom:8px;display:block}
.imgu-area p{font-size:12px;font-weight:700;color:var(--T2);margin-bottom:3px}
.imgu-area span{font-size:11px;color:var(--T3)}
.imgu-area input{display:none}
.imgprev{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.ipitem{position:relative;width:70px;height:70px;border-radius:10px;overflow:hidden;flex-shrink:0;animation:scaleIn .28s ease}
.ipitem img{width:100%;height:100%;object-fit:cover}
.ipdel{position:absolute;top:3px;right:3px;width:19px;height:19px;border-radius:6px;background:rgba(239,68,68,.88);color:white;font-size:9px;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center}
.cpick{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
.cpbtn{padding:5px 10px;border-radius:20px;border:2px solid var(--BDR);background:var(--SRF);font-family:'Tajawal',sans-serif;font-size:11px;font-weight:700;color:var(--T2);cursor:pointer;transition:var(--TR)}
.cpbtn.on{border-color:var(--P);background:rgba(91,47,212,.07);color:var(--P)}
.uprog{background:var(--BG2);border-radius:9px;overflow:hidden;height:5px;margin:6px 0}
.uprog-fill{height:100%;background:linear-gradient(90deg,var(--P),var(--A));border-radius:9px;width:0%;transition:width .3s}
.apfoot{padding:11px 14px;border-top:1px solid var(--BDR);flex-shrink:0}

/* SEARCH */
#srch-ov{position:fixed;inset:0;z-index:800;background:var(--SRF);transform:translateY(100%);transition:transform .36s cubic-bezier(.4,0,.2,1);display:flex;flex-direction:column}
#srch-ov.on{transform:translateY(0)}
.srchhead{display:flex;align-items:center;gap:8px;padding:10px 12px;padding-top:calc(env(safe-area-inset-top) + 56px);border-bottom:1px solid var(--BDR)}
.srchinp{flex:1;height:42px;border-radius:12px;border:2px solid var(--BDR);padding:0 12px;font-size:14px;background:var(--BG);color:var(--T);outline:none;transition:var(--TR)}
.srchinp:focus{border-color:var(--P);background:white}
.srchcancel{color:var(--P);font-size:14px;font-weight:700;border:none;background:none;cursor:pointer;font-family:'Tajawal',sans-serif;white-space:nowrap}
.srch-tabs{display:flex;border-bottom:2px solid var(--BDR);flex-shrink:0}
.srch-tab{flex:1;height:36px;border:none;background:none;font-family:'Tajawal',sans-serif;font-size:12px;font-weight:700;color:var(--T3);cursor:pointer;position:relative;transition:var(--TR)}
.srch-tab.on{color:var(--P)}
.srch-tab.on::after{content:'';position:absolute;bottom:-2px;left:0;right:0;height:2px;background:var(--P)}
.srchres{flex:1;overflow-y:auto;padding:12px}
.srchitem{display:flex;align-items:center;gap:10px;padding:10px;border-radius:11px;cursor:pointer;transition:var(--TR);margin-bottom:7px;background:var(--BG);border:1px solid var(--BDR)}
.srchitem:active{background:var(--BG2)}
.srchico{width:38px;height:38px;border-radius:10px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:17px;color:white}
.srchtxt{flex:1}.srchnm{font-size:13px;font-weight:700;color:var(--T)}.srchcat{font-size:11px;color:var(--T3);margin-top:1px}

/* TOAST */
#toast{position:fixed;bottom:calc(var(--NH) + env(safe-area-inset-bottom) + 12px);left:50%;transform:translateX(-50%) translateY(70px);background:var(--T);color:white;border-radius:11px;padding:9px 18px;font-size:13px;font-weight:600;z-index:9100;white-space:nowrap;opacity:0;pointer-events:none;display:flex;align-items:center;gap:7px;box-shadow:0 6px 24px rgba(0,0,0,.28);transition:transform .35s cubic-bezier(.4,0,.2,1),opacity .35s}
#toast.on{transform:translateX(-50%) translateY(0);opacity:1}
#toast.ok{background:var(--S)}#toast.err{background:var(--R)}#toast.info{background:var(--P)}

/* BOTTOM NAV */
#bnav{position:fixed;bottom:0;left:0;right:0;z-index:400;height:calc(var(--NH) + env(safe-area-inset-bottom));background:var(--SRF);border-top:1px solid var(--BDR);display:flex;justify-content:space-around;align-items:flex-start;padding-top:6px;padding-bottom:env(safe-area-inset-bottom);box-shadow:0 -2px 14px rgba(0,0,0,.06)}
.navit{display:flex;flex-direction:column;align-items:center;gap:2px;padding:4px 12px;border:none;background:none;cursor:pointer;color:var(--T3);transition:var(--TR);border-radius:10px;position:relative}
.navit.on{color:var(--P)}.navit i{font-size:18px;transition:var(--TR)}.navit.on i{transform:scale(1.1)}.navit span{font-family:'Tajawal',sans-serif;font-size:9px;font-weight:700}
.navbdg{position:absolute;top:2px;right:6px;min-width:14px;height:14px;border-radius:7px;background:var(--R);color:white;font-size:9px;font-weight:900;display:none;align-items:center;justify-content:center;border:2px solid var(--SRF);padding:0 2px}
.navbdg.on{display:flex}

/* ADS */
#ad-ov{position:fixed;inset:0;z-index:8500;background:rgba(18,14,46,.72);backdrop-filter:blur(5px);display:none;align-items:center;justify-content:center;padding:16px}
#ad-ov.on{display:flex;animation:fadeIn .35s ease}
.adbox{background:var(--SRF);border-radius:var(--RXL);width:100%;max-width:360px;overflow:hidden;box-shadow:0 24px 64px rgba(0,0,0,.3);animation:adIn .45s cubic-bezier(.34,1.56,.64,1)}
.adtimer{height:3px;background:var(--BDR);overflow:hidden}
.adtfill{height:100%;background:linear-gradient(90deg,var(--P),var(--A));width:0%;transition:width linear}
.adhdr{display:flex;align-items:center;justify-content:space-between;padding:10px 13px}
.adlbl{display:flex;align-items:center;gap:5px;background:var(--BG2);padding:3px 9px;border-radius:20px;font-size:10px;font-weight:700;color:var(--P)}
.adx{width:28px;height:28px;border-radius:8px;border:none;cursor:pointer;background:var(--BG2);color:var(--T2);font-size:13px;display:flex;align-items:center;justify-content:center}
.adph{width:100%;height:155px;display:flex;align-items:center;justify-content:center;font-size:52px}
.adbody{padding:13px 15px 16px}
.adspons{font-size:10px;color:var(--T3);font-weight:600;margin-bottom:3px}
.adtit{font-size:15px;font-weight:900;color:var(--T);margin-bottom:5px}
.adtxt{font-size:12px;color:var(--T2);line-height:1.55;margin-bottom:13px}
.adcta{display:flex;gap:7px}
.adbtn{flex:1;height:42px;border-radius:11px;border:none;cursor:pointer;font-family:'Tajawal',sans-serif;font-size:13px;font-weight:900;background:linear-gradient(135deg,var(--P),var(--PL));color:white;display:flex;align-items:center;justify-content:center;gap:7px;transition:var(--TR);text-decoration:none}
.adskip{height:42px;padding:0 13px;border-radius:11px;border:2px solid var(--BDR);cursor:pointer;font-family:'Tajawal',sans-serif;font-size:12px;font-weight:700;background:transparent;color:var(--T2)}
.adskip:disabled{opacity:.5;cursor:default}

/* LOCATION MODAL */
#loc-modal{position:fixed;inset:0;z-index:9000;background:rgba(18,14,46,.65);backdrop-filter:blur(4px);display:none;align-items:flex-end;justify-content:center;padding-bottom:env(safe-area-inset-bottom)}
#loc-modal.on{display:flex;animation:fadeIn .28s ease}
.locbox{background:var(--SRF);border-radius:20px 20px 0 0;width:100%;max-width:600px;animation:sheetUp .32s cubic-bezier(.4,0,.2,1)}
.lochdr{display:flex;justify-content:space-between;align-items:center;padding:14px 16px 11px;border-bottom:1px solid var(--BDR)}
.lochdr h3{font-size:15px;font-weight:900;color:var(--T);display:flex;align-items:center;gap:7px}
.locbody{padding:16px}
.loc-opt{display:flex;align-items:center;gap:11px;padding:13px;border-radius:13px;border:2px solid var(--BDR);margin-bottom:10px;cursor:pointer;transition:var(--TR)}
.loc-opt:active{border-color:var(--P);background:rgba(91,47,212,.03)}
.loc-opt-ico{width:40px;height:40px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.loc-opt-txt strong{font-size:13px;font-weight:700;color:var(--T);display:block}
.loc-opt-txt span{font-size:11px;color:var(--T3)}

/* PWA */
#pwa{position:fixed;bottom:calc(var(--NH) + env(safe-area-inset-bottom) + 10px);left:10px;right:10px;z-index:600;background:var(--SRF);border-radius:var(--RX);padding:11px;box-shadow:var(--SH3);border:1px solid var(--BDR);display:none;align-items:center;gap:10px;transform:translateY(110px);transition:transform .35s}
#pwa.on{display:flex;transform:translateY(0)}
.pwaico{width:42px;height:42px;border-radius:12px;flex-shrink:0;background:linear-gradient(135deg,var(--P),var(--PL));display:flex;align-items:center;justify-content:center;font-size:19px;color:white}
.pwatxt{flex:1}.pwatxt strong{font-size:13px;color:var(--T);display:block}.pwatxt span{font-size:11px;color:var(--T3)}
.pwaacts{display:flex;gap:5px}
.pwabtn{padding:7px 12px;border-radius:9px;border:none;cursor:pointer;font-family:'Tajawal',sans-serif;font-size:12px;font-weight:700;background:var(--P);color:white}
.pwadis{padding:7px 10px;border-radius:9px;border:1px solid var(--BDR);cursor:pointer;font-family:'Tajawal',sans-serif;font-size:12px;font-weight:700;background:transparent;color:var(--T3)}

/* UTILS */
.sp-wrap{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:50px 16px;gap:11px}
.sp{width:38px;height:38px;border-radius:50%;border:3px solid var(--BDR);border-top-color:var(--P);animation:spin .8s linear infinite}
.sptxt{font-size:12px;color:var(--T3);font-weight:600}
.empty-st{text-align:center;padding:50px 16px;display:flex;flex-direction:column;align-items:center;gap:10px}
.empty-st i{font-size:42px;color:var(--BDR)}.empty-st p{font-size:13px;font-weight:700;color:var(--T2)}.empty-st span{font-size:12px;color:var(--T3)}
.skel{background:linear-gradient(90deg,var(--BG) 25%,var(--BG2) 50%,var(--BG) 75%);background-size:200% 100%;animation:shimmer 1.5s infinite;border-radius:8px}
.divider{height:1px;background:var(--BDR);margin:0 13px}

/* RESPONSIVE */
@media(max-width:340px){
  :root{--HH:48px;--NH:50px;--fs-base:12px}
  .cgrid{grid-template-columns:repeat(3,1fr)!important}
  .cico{width:36px;height:36px;font-size:15px}
  .clbl{font-size:8px}
  .oi{width:38px;height:46px;font-size:18px}
  .hname{font-size:16px}
  .pslide img{height:170px!important}
  .finp,.fsel{height:42px;font-size:13px}
}
@media(min-width:420px){
  .cgrid{grid-template-columns:repeat(5,1fr)}
  .ugrid{grid-template-columns:repeat(2,1fr)}
}
@media(min-width:600px){
  .cgrid{grid-template-columns:repeat(6,1fr)}
  .igrid{grid-template-columns:repeat(3,1fr)}
}
@media(min-width:768px){
  :root{--HH:56px;--NH:62px}
  .ugrid{grid-template-columns:repeat(2,1fr)}
  .pslide img{height:280px}
}
</style>
<!-- SPLASH -->
<div id="splash">
  <div class="sc"></div><div class="sc"></div><div class="sc"></div>
  <div class="spl-ring"><svg viewBox="0 0 110 110"><circle cx="55" cy="55" r="45" fill="none" stroke="rgba(255,255,255,.2)" stroke-width="3"/><circle class="rp" cx="55" cy="55" r="45" fill="none" stroke="rgba(255,255,255,.8)" stroke-width="3" stroke-dasharray="283" stroke-dashoffset="283" stroke-linecap="round" transform="rotate(-90 55 55)"/></svg><div class="spl-in"><i class="fas fa-compass"></i></div></div>
  <div class="spl-t">دليل الخدمات</div>
  <div class="spl-s">دليلك الشامل لأفضل الخدمات</div>
  <div class="spl-dots"><div class="spl-d"></div><div class="spl-d"></div><div class="spl-d"></div></div>
</div>

<!-- AUTH -->
<div id="auth-wrap">
  <!-- LOGIN -->
  <div class="asc" id="sc-login">
    <div class="ah"><div class="ah-ico"><i class="fas fa-compass"></i></div><div class="ah-tit">أهلاً بك 👋</div><div class="ah-sub">سجّل دخولك للوصول لجميع الخدمات المتاحة</div></div>
    <div class="ab">
      <h2><i class="fas fa-sign-in-alt"></i>تسجيل الدخول</h2>
      <div class="fg"><label class="fl">رقم الهاتف</label><div class="fw"><i class="fas fa-phone fi"></i><input type="tel" class="finp" id="l-ph" placeholder="07xxxxxxxxx" maxlength="15" inputmode="tel"></div><div class="fe" id="l-ph-e"><i class="fas fa-circle-exclamation"></i><span></span></div></div>
      <div class="fg"><label class="fl">كلمة المرور</label><div class="fw"><i class="fas fa-lock fi"></i><input type="password" class="finp" id="l-pw" placeholder="••••••••" maxlength="30"><button class="ftgl" onclick="togglePw('l-pw',this)" type="button"><i class="far fa-eye"></i></button></div><div class="fe" id="l-pw-e"><i class="fas fa-circle-exclamation"></i><span></span></div></div>
      <div style="text-align:left;margin-bottom:18px"><span style="font-size:13px;color:var(--P);font-weight:700;cursor:pointer" onclick="showToast('خاصية استعادة كلمة المرور قريباً','info')">نسيت كلمة المرور؟</span></div>
      <button class="btn-p" id="l-btn" onclick="doLogin()"><i class="fas fa-sign-in-alt"></i><span>تسجيل الدخول</span></button>
      <div class="auth-sw">ليس لديك حساب؟ <span onclick="showAS('sc-reg')">إنشاء حساب جديد</span></div>
    </div>
  </div>
  <!-- REGISTER -->
  <div class="asc" id="sc-reg">
    <div class="ah"><div class="ah-ico"><i class="fas fa-user-plus"></i></div><div class="ah-tit">إنشاء حساب ✨</div><div class="ah-sub">انضم إلى دليل الخدمات الشامل</div></div>
    <div class="ab">
      <div class="steps"><div class="step active" id="st1"><div class="step-c"><i class="fas fa-user" style="font-size:12px"></i></div><div class="step-lb">البيانات</div></div><div class="step-ln" id="sl1"></div><div class="step" id="st2"><div class="step-c">2</div><div class="step-lb">الأمان</div></div><div class="step-ln" id="sl2"></div><div class="step" id="st3"><div class="step-c">3</div><div class="step-lb">التحقق</div></div></div>
      <!-- STEP 1 -->
      <div id="r-s1">
        <h2><i class="fas fa-id-card"></i>البيانات الشخصية</h2>
        <div class="fg"><label class="fl">الاسم الثلاثي <span style="color:var(--R)">*</span></label><div class="fw"><i class="fas fa-user fi"></i><input type="text" class="finp" id="r-nm" placeholder="الاسم الأول والثاني والثالث" maxlength="60"></div><div class="fe" id="r-nm-e"><i class="fas fa-circle-exclamation"></i><span></span></div></div>
        <div class="fg"><label class="fl">العنوان <span style="color:var(--R)">*</span></label><div class="fw"><i class="fas fa-map-marker-alt fi"></i><input type="text" class="finp" id="r-ad" placeholder="المحافظة / القضاء / المنطقة" maxlength="100"></div><div class="fe" id="r-ad-e"><i class="fas fa-circle-exclamation"></i><span></span></div></div>
        <div class="fg"><label class="fl">رقم الهاتف <span style="color:var(--R)">*</span></label><div class="fw"><i class="fas fa-phone fi"></i><input type="tel" class="finp" id="r-ph" placeholder="07xxxxxxxxx" maxlength="15" inputmode="tel"></div><div class="fe" id="r-ph-e"><i class="fas fa-circle-exclamation"></i><span></span></div></div>
        <div class="fg"><label class="fl">نوع الحساب / المهنة <span style="color:var(--R)">*</span></label><div class="fw"><i class="fas fa-briefcase fi"></i><select class="fsel" id="r-tp"><option value="">اختر تخصصك...</option><option value="user">مستخدم عادي</option><option value="lawyer">محامي ⚖️</option><option value="doctor">طبيب 👨‍⚕️</option><option value="restaurant">مطعم 🍽️</option><option value="market">سوق / محل 🛒</option><option value="realestate">وسيط عقارات 🏠</option><option value="beauty">صالون تجميل 💄</option><option value="cars">وكالة سيارات 🚗</option><option value="travel">وكالة سفر ✈️</option><option value="sports">نادي رياضي 🏋️</option><option value="education">مدرسة / معهد 🎓</option><option value="hotel">فندق 🏨</option><option value="pharmacy">صيدلاني 💊</option><option value="teacher">مدرس خصوصي 📚</option><option value="clinic">عيادة 🏥</option><option value="electronics">إلكترونيات 💻</option><option value="furniture">مفروشات 🛋️</option><option value="other">أخرى</option></select><i class="fas fa-chevron-down" style="position:absolute;left:14px;top:50%;transform:translateY(-50%);color:var(--T3);pointer-events:none;font-size:13px"></i></div><div class="fe" id="r-tp-e"><i class="fas fa-circle-exclamation"></i><span></span></div></div>
        <!-- Location box -->
        <div class="loc-box" id="reg-loc-box" onclick="captureLocation('reg')">
          <div class="loc-row">
            <div class="loc-ico"><i class="fas fa-location-dot"></i></div>
            <div class="loc-txt">
              <div class="loc-lbl">الموقع الجغرافي</div>
              <div class="loc-val" id="reg-loc-txt">اضغط للحصول على موقعك تلقائياً</div>
            </div>
            <div class="loc-act" id="reg-loc-act"><i class="fas fa-crosshairs"></i></div>
          </div>
        </div>
        <div class="fg"><label class="fl">الوصف المهني <span style="color:var(--T3);font-size:11px">(اختياري)</span></label><div class="fw" style="position:relative"><i class="fas fa-align-right fi" style="top:18px;transform:none"></i><textarea class="finp" id="r-bio" style="height:80px;padding-right:46px;padding-top:14px;resize:none;line-height:1.5" placeholder="تعريف مختصر عن نفسك أو نشاطك..." maxlength="200"></textarea></div></div>
        <button class="btn-p" onclick="goS2()"><span>التالي</span><i class="fas fa-arrow-left"></i></button>
        <div class="auth-sw">لديك حساب؟ <span onclick="showAS('sc-login')">تسجيل الدخول</span></div>
      </div>
      <!-- STEP 2 -->
      <div id="r-s2" style="display:none">
        <h2><i class="fas fa-shield-alt"></i>كلمة المرور</h2>
        <div class="fg"><label class="fl">كلمة المرور</label><div class="fw"><i class="fas fa-lock fi"></i><input type="password" class="finp" id="r-pw" placeholder="••••••••" maxlength="30" oninput="chkPw(this.value)"><button class="ftgl" onclick="togglePw('r-pw',this)" type="button"><i class="far fa-eye"></i></button></div><div class="pw-bars"><div class="pb" id="pb1"></div><div class="pb" id="pb2"></div><div class="pb" id="pb3"></div><div class="pb" id="pb4"></div></div><div id="pw-l" style="font-size:11px;color:var(--T3)">أدخل كلمة المرور</div><div class="fe" id="r-pw-e"><i class="fas fa-circle-exclamation"></i><span></span></div></div>
        <div class="fg"><label class="fl">تأكيد كلمة المرور</label><div class="fw"><i class="fas fa-lock fi"></i><input type="password" class="finp" id="r-pw2" placeholder="أعد كتابة كلمة المرور" maxlength="30"><button class="ftgl" onclick="togglePw('r-pw2',this)" type="button"><i class="far fa-eye"></i></button></div><div class="fe" id="r-pw2-e"><i class="fas fa-circle-exclamation"></i><span></span></div></div>
        <div class="tr-row" id="trw" onclick="tglT()"><div class="tr-cb"><i class="fas fa-check"></i></div><div class="tr-txt">أوافق على <span class="tr-lnk" onclick="event.stopPropagation();openTerms()">الشروط والأحكام</span> وسياسة الخصوصية</div></div>
        <div class="fe" id="tr-e"><i class="fas fa-circle-exclamation"></i><span></span></div>
        <button class="btn-wa" onclick="goS3()"><i class="fab fa-whatsapp"></i><span>إرسال رمز التحقق عبر واتساب</span></button>
        <button class="btn-s" onclick="backS1()"><i class="fas fa-arrow-right"></i><span>رجوع</span></button>
      </div>
    </div>
  </div>
  <!-- OTP -->
  <div class="asc" id="sc-otp">
    <div class="ah"><div class="ah-ico"><i class="fab fa-whatsapp"></i></div><div class="ah-tit">التحقق 📱</div><div class="ah-sub">أدخل رمز التحقق المرسل لهاتفك</div></div>
    <div class="ab">
      <div class="steps"><div class="step done"><div class="step-c"><i class="fas fa-check" style="font-size:12px"></i></div><div class="step-lb">البيانات</div></div><div class="step-ln" style="background:var(--S)"></div><div class="step done"><div class="step-c"><i class="fas fa-check" style="font-size:12px"></i></div><div class="step-lb">الأمان</div></div><div class="step-ln" style="background:var(--S)"></div><div class="step active"><div class="step-c">3</div><div class="step-lb">التحقق</div></div></div>
      <h2><i class="fas fa-key"></i>رمز التحقق</h2>
      <div class="otp-desc">تم إرسال رمز 6 أرقام عبر واتساب إلى<br><strong id="otp-ph"></strong><br><small style="color:var(--T3);font-size:12px">افتح رسالة الواتساب وأرسلها لاستلام الرمز ⚡</small></div>
      <div class="otp-row"><input class="oi" maxlength="1" type="number" inputmode="numeric" id="o0"><input class="oi" maxlength="1" type="number" inputmode="numeric" id="o1"><input class="oi" maxlength="1" type="number" inputmode="numeric" id="o2"><input class="oi" maxlength="1" type="number" inputmode="numeric" id="o3"><input class="oi" maxlength="1" type="number" inputmode="numeric" id="o4"><input class="oi" maxlength="1" type="number" inputmode="numeric" id="o5"></div>
      <div style="text-align:center;font-size:13px;color:var(--T3);margin-bottom:16px">انتهاء الرمز خلال: <span id="otp-cd" style="color:var(--P);font-weight:700">03:00</span></div>
      <button class="btn-p" id="v-btn" onclick="verOTP()"><i class="fas fa-check-circle"></i><span>تحقق وأنشئ الحساب</span></button>
      <div style="text-align:center;font-size:14px;color:var(--T3);margin-bottom:12px">لم يصلك الرمز؟ <button id="resend-btn" disabled onclick="resendOTP()" style="color:var(--P);font-weight:700;font-size:14px;font-family:Tajawal,sans-serif;background:none;border:none;cursor:pointer">إعادة الإرسال</button></div>
      <div id="demo-hint" style="background:linear-gradient(135deg,#FFF8E6,#FFF3CC);border:1px solid #FFD93D;border-radius:12px;padding:12px;text-align:center;margin-bottom:14px"><div style="font-size:11px;color:#92400E;font-weight:700;margin-bottom:6px">🔧 وضع التجربة</div><div id="demo-code" style="font-size:28px;font-weight:900;color:var(--P);letter-spacing:8px"></div></div>
      <button class="btn-s" onclick="showAS('sc-reg');backS2()"><i class="fas fa-arrow-right"></i><span>رجوع</span></button>
    </div>
  </div>
</div>

<!-- TERMS -->
<div id="tmod"><div class="tbox"><div class="thdr"><h3>📋 الشروط والأحكام</h3><button class="tcls" onclick="closeTerms()"><i class="fas fa-times"></i></button></div><div class="tbody"><div class="ts"><h4><i class="fas fa-handshake"></i>1. القبول والموافقة</h4><p>باستخدام تطبيق دليل الخدمات فإنك توافق على الالتزام بهذه الشروط. نحتفظ بحق تعديلها مع الإخطار المسبق.</p></div><div class="ts"><h4><i class="fas fa-user-shield"></i>2. الحسابات والبيانات الشخصية</h4><p>• يجب أن تكون معلوماتك صحيحة ودقيقة.<br>• أنت مسؤول عن سرية كلمة المرور.<br>• يُحظر إنشاء حسابات متعددة بنفس الهاتف.<br>• نحتفظ بحق تعليق الحسابات المخالفة.</p></div><div class="ts"><h4><i class="fas fa-map-marker-alt"></i>3. بيانات الموقع الجغرافي</h4><p>عند منح الإذن، نجمع بيانات موقعك لعرضك ضمن نتائج البحث لمستخدمين قريبين. يمكنك تحديث أو حذف هذه البيانات في أي وقت من إعدادات حسابك.</p></div><div class="ts"><h4><i class="fas fa-bullhorn"></i>4. نشر المنشورات</h4><p>• يجب أن تكون منشوراتك حقيقية وأخلاقية.<br>• يُحظر نشر محتوى مضلل أو مسيء.<br>• أنت مسؤول قانونياً عن محتوى منشوراتك.<br>• نحتفظ بحق إزالة أي منشور مخالف.</p></div><div class="ts"><h4><i class="fas fa-comments"></i>5. نظام الرسائل والدردشة</h4><p>• الرسائل المتبادلة مسؤولية الطرفين.<br>• يُحظر استخدام الدردشة للتحرش أو الإساءة.<br>• نحتفظ بحق حذف المحادثات المخالفة.</p></div><div class="ts"><h4><i class="fas fa-eye-slash"></i>6. الخصوصية</h4><p>• نجمع فقط البيانات الضرورية.<br>• لا نبيع بياناتك لأطراف ثالثة.<br>• لك الحق في طلب حذف بياناتك.</p></div><div class="ts"><h4><i class="fas fa-ban"></i>7. الاستخدام المحظور</h4><p>يُحظر استخدام التطبيق لأغراض غير قانونية، نشر محتوى مسيء، محاولة الاختراق، انتحال هوية أشخاص آخرين.</p></div><div class="ts"><h4><i class="fas fa-gavel"></i>8. القانون المطبّق</h4><p>تخضع هذه الشروط لقوانين جمهورية العراق.</p></div></div><div class="tftr"><button class="btn-p" style="margin-bottom:0" onclick="acceptTerms()"><i class="fas fa-check"></i><span>أوافق على الشروط والأحكام</span></button></div></div></div>

<!-- AD -->
<div id="ad-ov"><div class="adbox"><div class="adtimer"><div class="adtfill" id="atf"></div></div><div class="adhdr"><div class="adlbl"><i class="fas fa-bullhorn"></i>إعلان</div><button class="adx" id="ad-x" onclick="closeAd()" disabled><i class="fas fa-times"></i></button></div><div id="ad-cnt"></div></div></div>

<!-- LOCATION MODAL -->
<div id="loc-modal"><div class="locbox"><div class="lochdr"><h3><i class="fas fa-location-dot" style="color:var(--P)"></i>تحديث الموقع</h3><button class="tcls" onclick="document.getElementById('loc-modal').classList.remove('on')"><i class="fas fa-times"></i></button></div><div class="locbody"><div class="loc-opt" onclick="captureLocation('profile')"><div class="loc-opt-ico" style="background:linear-gradient(135deg,var(--P),var(--PL));color:white"><i class="fas fa-crosshairs"></i></div><div class="loc-opt-txt"><strong>الموقع التلقائي GPS</strong><span>الحصول على موقعك الحالي بدقة</span></div></div><div class="loc-opt" onclick="openManualLoc()"><div class="loc-opt-ico" style="background:linear-gradient(135deg,var(--A),var(--AL));color:white"><i class="fas fa-keyboard"></i></div><div class="loc-opt-txt"><strong>إدخال الموقع يدوياً</strong><span>أكتب عنوانك بالتفصيل</span></div></div><div class="loc-opt" onclick="clearLocation()"><div class="loc-opt-ico" style="background:linear-gradient(135deg,#EF4444,#f87171);color:white"><i class="fas fa-trash-alt"></i></div><div class="loc-opt-txt"><strong>حذف الموقع</strong><span>إزالة بيانات موقعك من التطبيق</span></div></div></div></div></div>

<!-- APP -->
<div id="app" style="display:none">
  <header id="hdr">
    <button id="hback" class="hbtn" onclick="goBack()"><i class="fas fa-chevron-right"></i></button>
    <div class="hlogo" id="hlogo"><i class="fas fa-compass"></i><span>دليل الخدمات</span></div>
    <span id="htit"></span>
    <div class="hacts">
      <button class="hbtn" onclick="openSrch()"><i class="fas fa-search"></i></button>
      <button class="hbtn" onclick="showView('chat-list')" id="hchat-btn" style="position:relative"><i class="fas fa-comment-dots"></i><span class="hbadge" id="hchat-bdg" style="display:none">0</span></button>
      <div class="hav" id="hav" onclick="showView('profile')">؟</div>
    </div>
  </header>

  <div id="main">
    <!-- HOME -->
    <div id="v-home" class="view on">
      <div class="hhero">
        <div class="hgreet">مرحباً <span style="display:inline-block;animation:waveHand 1s ease 1s 2">👋</span></div>
        <div class="hname" id="h-nm">ابحث عن <span>الخدمة</span> التي تحتاجها</div>
        <div class="sb"><input type="text" placeholder="ابحث عن خدمة أو مستخدم..." readonly onclick="openSrch()"><i class="fas fa-search sico"></i></div>
        <svg class="hw" viewBox="0 0 1200 46" preserveAspectRatio="none"><path d="M0,23 C300,46 900,0 1200,23 L1200,46 L0,46 Z" fill="#F0EEFF"/></svg>
      </div>
      <div class="stats-row">
        <div class="stat"><div class="stn" id="sc-users">—</div><div class="stl">مستخدم مسجل</div></div>
        <div class="stat"><div class="stn" id="sc-posts">—</div><div class="stl">منشور</div></div>
        <div class="stat"><div class="stn">20+</div><div class="stl">فئة خدمة</div></div>
      </div>
      <div class="sec"><div class="sechdr"><span class="secttl">الفئات والخدمات</span><span class="secmore" onclick="showView('feed')">المنشورات <i class="fas fa-arrow-left"></i></span></div><div class="cgrid" id="cgrid"></div></div>
      <div style="height:14px"></div>
      <div class="bad" onclick="window.open('https://wa.me/9647801234567?text=أريد الإعلان في دليل الخدمات','_blank')">
        <div class="badico"><i class="fas fa-tag"></i></div>
        <div class="badtxt"><div class="badtit">أعلن خدمتك معنا!</div><div class="badsub">وصول لآلاف العملاء يومياً</div></div>
        <div class="badcta">تواصل الآن</div>
      </div>
      <div class="sec"><div class="sechdr"><span class="secttl">أحدث الأعضاء المسجلين</span></div></div>
      <div class="fsc" id="fsc"><div class="sp-wrap" style="width:200px;min-width:200px"><div class="sp" style="width:30px;height:30px;border-width:2px"></div></div></div>
      <div style="height:10px"></div>
    </div>

    <!-- CATEGORY / USERS LIST -->
    <div id="v-list" class="view">
      <div class="lbar">
        <div class="lbrow">
          <div class="liwrap"><i class="fas fa-search"></i><input type="text" class="li" id="l-inp" placeholder="ابحث بالاسم أو الأحرف..." oninput="filterUsers(this.value)"></div>
          <select class="lsel" id="l-sort" onchange="filterUsers(document.getElementById('l-inp').value)"><option value="name">الاسم</option><option value="location">الأقرب</option><option value="new">الأحدث</option></select>
        </div>
      </div>
      <div class="ugrid" id="ugrid"></div>
      <!-- Service listings (legacy) -->
      <div id="svc-section" style="display:none">
        <div class="sec" style="padding-top:14px"><div class="sechdr"><span class="secttl">خدمات مدرجة</span></div></div>
        <div class="igrid" id="igrid"></div>
      </div>
    </div>

    <!-- DETAIL (service) -->
    <div id="v-detail" class="view">
      <div class="dhero" id="dhero"><div class="dheroph" id="dheroph"><i class="fas fa-image"></i></div></div>
      <div class="dbody">
        <div class="dcard" id="dcard"></div>
        <div class="bkcard">
          <div class="bktit"><i class="fas fa-calendar-check"></i>إرسال طلب</div>
          <div class="fg"><label class="fl">الاسم الكامل</label><div class="fw"><i class="fas fa-user fi"></i><input type="text" class="finp" id="bk-n" style="padding-right:46px;padding-left:14px" placeholder="اسمك الكامل" readonly></div></div>
          <div class="fg"><label class="fl">رقم الهاتف</label><div class="fw"><i class="fas fa-phone fi"></i><input type="tel" class="finp" id="bk-p" style="padding-right:46px;padding-left:14px" placeholder="رقم هاتفك" readonly></div></div>
          <div class="fg"><label class="fl">العنوان</label><div class="fw"><i class="fas fa-map-marker-alt fi"></i><input type="text" class="finp" id="bk-a" style="padding-right:46px;padding-left:14px" placeholder="عنوانك"></div></div>
          <div class="fg"><label class="fl">تفاصيل الطلب</label><textarea class="ftxt" id="bk-d" style="min-height:86px" placeholder="اكتب تفاصيل طلبك..."></textarea></div>
          <button class="btnbk" id="btn-bk"><i class="fas fa-paper-plane"></i><span>إرسال الطلب</span></button>
        </div>
      </div>
    </div>

    <!-- USER PUBLIC PROFILE -->
    <div id="v-user-profile" class="view">
      <div class="upphero" id="upp-hero">
        <div class="upp-av" id="upp-av">؟</div>
        <div class="upp-nm" id="upp-nm">—</div>
        <div class="upp-type" id="upp-type"><i class="fas fa-user"></i><span>مستخدم</span></div>
        <div class="upp-loc" id="upp-loc" style="display:none"><i class="fas fa-map-marker-alt"></i><span></span></div>
        <div class="upp-actions" id="upp-acts"></div>
      </div>
      <div class="upp-body">
        <div class="upp-stat-bar">
          <div class="upp-stat"><div class="upp-stn" id="upp-posts">0</div><div class="upp-stl">منشور</div></div>
          <div class="upp-stat"><div class="upp-stn" id="upp-rating">⭐ 5.0</div><div class="upp-stl">التقييم</div></div>
          <div class="upp-stat"><div class="upp-stn" id="upp-joined">—</div><div class="upp-stl">انضم</div></div>
        </div>
        <div id="upp-bio-card" style="display:none;background:var(--SRF);border-radius:var(--RXL);padding:16px 18px;margin-bottom:14px;box-shadow:var(--SH1);border:1px solid var(--BDR)">
          <div style="font-size:13px;font-weight:700;color:var(--P);margin-bottom:8px;display:flex;align-items:center;gap:6px"><i class="fas fa-info-circle"></i>نبذة</div>
          <div id="upp-bio" style="font-size:14px;color:var(--T2);line-height:1.65"></div>
        </div>
        <div style="font-size:15px;font-weight:900;color:var(--T);margin-bottom:12px;display:flex;align-items:center;gap:8px"><i class="fas fa-th" style="color:var(--P);font-size:14px"></i>منشورات المستخدم</div>
        <div id="upp-posts-list" class="feed-list" style="padding:0"></div>
      </div>
    </div>

    <!-- FEED -->
    <div id="v-feed" class="view">
      <div class="feed-top">
        <div style="font-size:22px;font-weight:900;color:white;margin-bottom:4px;position:relative;z-index:1">📢 المنشورات العامة</div>
        <div style="font-size:13px;color:rgba(255,255,255,.75);position:relative;z-index:1">اكتشف وتواصل مع أصحاب الخدمات</div>
      </div>
      <div class="feed-filters" id="feed-filters"><button class="ffbtn on" onclick="filterFeed('all',this)">الكل</button><button class="ffbtn" onclick="filterFeed('offer',this)">عروض خدمة ✅</button><button class="ffbtn" onclick="filterFeed('request',this)">طلب خدمة 🔍</button></div>
      <div id="feed-list" class="feed-list"><div class="sp-wrap"><div class="sp"></div><span class="sptxt">جاري تحميل المنشورات...</span></div></div>
    </div>

    <!-- CHAT LIST -->
    <div id="v-chat-list" class="view">
      <div style="background:linear-gradient(135deg,var(--P),var(--PL));padding:20px 16px 26px;position:relative;overflow:hidden">
        <div style="position:absolute;bottom:-14px;left:0;right:0;height:28px;background:var(--BG);border-radius:14px 14px 0 0"></div>
        <div style="font-size:22px;font-weight:900;color:white;margin-bottom:4px;position:relative;z-index:1">💬 الرسائل</div>
        <div style="font-size:13px;color:rgba(255,255,255,.75);position:relative;z-index:1">تواصل مباشر مع أصحاب الخدمات</div>
      </div>
      <div class="chat-list" id="chat-list-wrap"><div class="sp-wrap"><div class="sp"></div><span class="sptxt">جاري التحميل...</span></div></div>
    </div>

    <!-- PROFILE -->
    <div id="v-profile" class="view">
      <div class="phero">
        <div class="pav-lg" id="pf-av">؟</div>
        <div class="pnm-lg" id="pf-nm">المستخدم</div>
        <div class="ptp-lg" id="pf-tp"><i class="fas fa-user"></i><span>مستخدم</span></div>
        <div class="pph-lg" id="pf-ph"></div>
        <div class="ploc-bar" id="pf-loc" onclick="document.getElementById('loc-modal').classList.add('on')"><i class="fas fa-map-marker-alt"></i><span id="pf-loc-txt">أضف موقعك</span><i class="fas fa-pen" style="font-size:10px"></i></div>
      </div>
      <div style="padding:0 14px;margin-top:-36px;position:relative;z-index:1">
        <div class="prof-stats">
          <div class="stat" style="cursor:pointer" onclick="switchTab('posts')"><div class="pstn" id="ps-posts">0</div><div class="pstl">منشوراتي</div></div>
          <div class="stat" style="cursor:pointer" onclick="switchTab('fav')"><div class="pstn" id="ps-favs">0</div><div class="pstl">المفضلة</div></div>
          <div class="stat"><div class="pstn" id="ps-bks">0</div><div class="pstl">طلباتي</div></div>
        </div>
      </div>
      <div class="prof-body">
        <div class="ptabs">
          <button class="ptab on" id="ptab-posts" onclick="switchTab('posts')"><i class="fas fa-th-large" style="margin-left:5px;font-size:11px"></i>منشوراتي</button>
          <button class="ptab" id="ptab-fav" onclick="switchTab('fav')"><i class="far fa-heart" style="margin-left:5px;font-size:11px"></i>المفضلة</button>
          <button class="ptab" id="ptab-set" onclick="switchTab('set')"><i class="fas fa-cog" style="margin-left:5px;font-size:11px"></i>الإعدادات</button>
        </div>
        <div id="tc-posts"><div class="my-posts-wrap" id="my-posts"></div></div>
        <div id="tc-fav" style="display:none"><div class="igrid" id="fav-igrid" style="padding:0"></div></div>
        <div id="tc-set" style="display:none">
          <div class="setcard">
            <div class="setrow" onclick="document.getElementById('loc-modal').classList.add('on')"><div class="setico" style="background:linear-gradient(135deg,#F0F5FF,#E6E0FF);color:var(--P)"><i class="fas fa-map-marker-alt"></i></div><div class="settxt"><div class="setlbl">تحديث الموقع</div><div class="setsub" id="set-loc-txt">لم يُضف موقع بعد</div></div><i class="fas fa-chevron-left" style="color:var(--T3);font-size:12px"></i></div>
            <div class="setrow" onclick="showView('feed')"><div class="setico" style="background:#F0F5FF;color:var(--P)"><i class="fas fa-rss"></i></div><div class="settxt"><div class="setlbl">المنشورات العامة</div><div class="setsub">استعرض جميع المنشورات</div></div><i class="fas fa-chevron-left" style="color:var(--T3);font-size:12px"></i></div>
            <div class="setrow" onclick="shareApp()"><div class="setico" style="background:#FFF8F0;color:#F59E0B"><i class="fas fa-share-alt"></i></div><div class="settxt"><div class="setlbl">مشاركة التطبيق</div><div class="setsub">شارك مع أصدقائك</div></div><i class="fas fa-chevron-left" style="color:var(--T3);font-size:12px"></i></div>
            <div class="setrow" onclick="openTerms()"><div class="setico" style="background:#F0F5FF;color:var(--P)"><i class="fas fa-file-contract"></i></div><div class="settxt"><div class="setlbl">الشروط والأحكام</div></div><i class="fas fa-chevron-left" style="color:var(--T3);font-size:12px"></i></div>
            <div class="setrow" onclick="window.open('https://wa.me/9647801234567','_blank')"><div class="setico" style="background:#F0FFF4;color:#25D366"><i class="fab fa-whatsapp"></i></div><div class="settxt"><div class="setlbl">تواصل معنا</div><div class="setsub">دعم فني عبر واتساب</div></div><i class="fas fa-chevron-left" style="color:var(--T3);font-size:12px"></i></div>
            <div class="setrow" onclick="doLogout()"><div class="setico" style="background:#FFF0F0;color:#EF4444"><i class="fas fa-sign-out-alt"></i></div><div class="settxt"><div class="setlbl" style="color:#EF4444">تسجيل الخروج</div></div><i class="fas fa-chevron-left" style="color:var(--T3);font-size:12px"></i></div>
          </div>
        </div>
      </div>
    </div>

    <!-- FAVORITES -->
    <div id="v-favorites" class="view">
      <div class="sec" style="padding-top:18px"><div class="sechdr"><span class="secttl">المفضلة</span></div></div>
      <div class="igrid" id="fav-igrid2"></div>
    </div>

  </div><!-- main -->

  <!-- BOTTOM NAV -->
  <nav id="bnav">
    <button class="navit on" data-v="home" onclick="showView('home')"><i class="fas fa-home"></i><span>الرئيسية</span></button>
    <button class="navit" data-v="feed" onclick="showView('feed')"><i class="fas fa-rss"></i><span>عام</span></button>
    <button class="navit" data-v="chat-list" onclick="showView('chat-list')"><i class="fas fa-comment-dots"></i><span>الرسائل</span><span class="navbdg" id="nav-chat-bdg">0</span></button>
    <button class="navit" data-v="profile" onclick="showView('profile')"><i class="fas fa-user-circle"></i><span>حسابي</span></button>
  </nav>

  <!-- FAB -->
  <button id="fab" onclick="openAddPost()" title="إضافة منشور"><i class="fas fa-plus"></i></button>

</div><!-- app -->

<!-- CHAT CONVERSATION (full screen slide) -->
<div id="chat-conv">
  <div class="conv-hdr">
    <button class="conv-back" onclick="closeChat()"><i class="fas fa-chevron-right"></i></button>
    <div class="conv-av" id="cv-av">؟</div>
    <div class="conv-info">
      <div class="conv-nm" id="cv-nm">—</div>
      <div class="conv-status" id="cv-status">—</div>
    </div>
    <div class="conv-acts">
      <button class="conv-act" id="cv-call" onclick="convCall()"><i class="fas fa-phone"></i></button>
      <button class="conv-act" id="cv-wa" onclick="convWA()"><i class="fab fa-whatsapp"></i></button>
    </div>
  </div>
  <div class="msgs-area" id="msgs-area"></div>
  <div class="conv-inp-bar">
    <button class="conv-img-btn" onclick="document.getElementById('chat-img-inp').click()"><i class="fas fa-image"></i></button>
    <input type="file" id="chat-img-inp" accept="image/*" style="display:none" onchange="sendChatImg(event)">
    <input type="text" class="conv-inp" id="conv-inp" placeholder="اكتب رسالتك..." onkeydown="if(event.key==='Enter')sendMsg()">
    <button class="conv-send" onclick="sendMsg()"><i class="fas fa-paper-plane" style="font-size:16px"></i></button>
  </div>
</div>

<!-- ADD POST SHEET -->
<div id="ap-ov">
  <div class="apsheet">
    <div class="ap-handle"></div>
    <div class="aphdr"><h3><i class="fas fa-plus-circle"></i>إضافة منشور جديد</h3><button class="apx" onclick="closeAddPost()"><i class="fas fa-times"></i></button></div>
    <div class="apbody">
      <!-- Post type -->
      <div class="ap-type-row">
        <button class="apt-btn offer on" id="apt-offer" onclick="setPostType('offer',this)"><i class="fas fa-hand-holding-heart"></i>أعرض خدمة</button>
        <button class="apt-btn req" id="apt-req" onclick="setPostType('request',this)"><i class="fas fa-search"></i>أطلب خدمة</button>
      </div>
      <!-- Images -->
      <div class="imgu-area" id="imgu-area" onclick="document.getElementById('img-file').click()" ondragover="event.preventDefault();this.classList.add('drag')" ondragleave="this.classList.remove('drag')" ondrop="handleDrop(event)">
        <input type="file" id="img-file" accept="image/*" multiple onchange="handleImgs(event)">
        <i class="fas fa-cloud-upload-alt"></i>
        <p>اختر صور المنشور <span style="color:var(--T3)">(اختياري)</span></p>
        <span>اضغط لاختيار صورة أو أكثر (حد أقصى 2 صور)</span>
      </div>
      <div class="imgprev" id="imgprev"></div>
      <div id="img-hint" style="font-size:12px;font-weight:700;margin-top:6px;margin-bottom:14px"></div>
      <!-- Category pick -->
      <div class="fg"><label class="fl">الفئة <span style="color:var(--R)">*</span></label><div class="cpick" id="cpick"></div><div class="fe" id="ap-cat-e"><i class="fas fa-circle-exclamation"></i><span></span></div></div>
      <!-- Fields -->
      <div class="fg"><label class="fl">عنوان المنشور <span style="color:var(--R)">*</span></label><div class="fw"><i class="fas fa-heading fi"></i><input type="text" class="finp" id="ap-title" placeholder="اسم النشاط أو الخدمة" maxlength="80"></div><div class="fe" id="ap-tit-e"><i class="fas fa-circle-exclamation"></i><span></span></div></div>
      <div class="fg"><label class="fl">العنوان / الموقع <span style="color:var(--R)">*</span></label><div class="fw"><i class="fas fa-map-marker-alt fi"></i><input type="text" class="finp" id="ap-addr" placeholder="المحافظة / القضاء / المنطقة" maxlength="100"></div><div class="fe" id="ap-adr-e"><i class="fas fa-circle-exclamation"></i><span></span></div></div>
      <div class="fg"><label class="fl">رقم الهاتف للتواصل <span style="color:var(--R)">*</span></label><div class="fw"><i class="fas fa-phone fi"></i><input type="tel" class="finp" id="ap-ph" placeholder="07xxxxxxxxx" maxlength="15" inputmode="tel"></div><div class="fe" id="ap-ph-e"><i class="fas fa-circle-exclamation"></i><span></span></div></div>
      <div class="fg"><label class="fl">رقم الواتساب <span style="color:var(--T3);font-size:11px">(اختياري)</span></label><div class="fw"><i class="fab fa-whatsapp fi" style="color:#25D366"></i><input type="tel" class="finp" id="ap-wa" placeholder="07xxxxxxxxx" maxlength="15" inputmode="tel"></div></div>
      <div class="fg">
        <label class="fl">الوصف <span style="color:var(--R)">*</span></label>
        <div class="fw" style="position:relative"><i class="fas fa-align-right fi" style="top:18px;transform:none"></i><textarea class="finp" id="ap-desc" style="height:90px;padding-right:46px;padding-top:14px;resize:vertical;line-height:1.5" placeholder="اكتب وصفاً مختصراً..." maxlength="300" oninput="document.getElementById('dcnt').textContent=this.value.length"></textarea></div>
        <div style="font-size:11px;color:var(--T3);margin-top:3px;text-align:left"><span id="dcnt">0</span>/300</div>
        <div class="fe" id="ap-dsc-e"><i class="fas fa-circle-exclamation"></i><span></span></div>
      </div>
      <div class="fg"><label class="fl">رابط الانستغرام <span style="color:var(--T3);font-size:11px">(اختياري)</span></label><div class="fw"><i class="fab fa-instagram fi" style="color:#dc2743"></i><input type="url" class="finp" id="ap-ig" placeholder="https://instagram.com/..." maxlength="200"></div></div>
      <div class="fg"><label class="fl">رابط الفيسبوك <span style="color:var(--T3);font-size:11px">(اختياري)</span></label><div class="fw"><i class="fab fa-facebook-f fi" style="color:#1877F2"></i><input type="url" class="finp" id="ap-fb" placeholder="https://facebook.com/..." maxlength="200"></div></div>
      <div id="upwrap" style="display:none"><div style="font-size:13px;color:var(--P);font-weight:700;margin-bottom:6px">⬆️ جاري رفع الصور...</div><div class="uprog"><div class="uprog-fill" id="upfill"></div></div></div>
    </div>
    <div class="apfoot"><button class="btn-p" style="margin-bottom:0" id="ap-sub" onclick="submitPost()"><i class="fas fa-paper-plane"></i><span>نشر المنشور</span></button></div>
  </div>
</div>

<!-- SEARCH OVERLAY -->
<div id="srch-ov">
  <div class="srchhead"><input type="text" class="srchinp" id="si" placeholder="ابحث عن خدمة أو مستخدم..." oninput="doSrch(this.value)"><button class="srchcancel" onclick="closeSrch()">إلغاء</button></div>
  <div class="srch-tabs">
    <button class="srch-tab on" id="st-all" onclick="setSrchTab('all',this)">الكل</button>
    <button class="srch-tab" id="st-users" onclick="setSrchTab('users',this)">المستخدمون</button>
    <button class="srch-tab" id="st-posts" onclick="setSrchTab('posts',this)">المنشورات</button>
  </div>
  <div class="srchres" id="sr"><div style="text-align:center;padding:50px 20px;color:var(--T3)"><i class="fas fa-search" style="font-size:36px;margin-bottom:12px;display:block;opacity:.4"></i>ابحث عن اسم أو خدمة أو مستخدم</div></div>
</div>

<div id="toast"></div>
<div id="pwa"><div class="pwaico"><i class="fas fa-compass"></i></div><div class="pwatxt"><strong>تثبيت دليل الخدمات</strong><span>أضفه لشاشتك الرئيسية</span></div><div class="pwaacts"><button class="pwabtn" onclick="promptInstall()">تثبيت</button><button class="pwadis" onclick="dismissPWA()">لاحقاً</button></div></div>
<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
<script>
firebase.initializeApp({
  apiKey:"AIzaSyDGpAHia_wEmrhnmYjrPf1n1TrAzwEMiAI",
  authDomain:"messageemeapp.firebaseapp.com",
  projectId:"messageemeapp",
  storageBucket:"messageemeapp.appspot.com",
  messagingSenderId:"278680662267",
  appId:"1:278680662267:web:cb9a86a0cd4709b86222b2"
});
const db = firebase.firestore();
const storage = firebase.storage();
const FS = firebase.firestore.FieldValue;

// ==============================
// CATEGORIES & CONSTANTS
// ==============================
const CATS = [
  {id:'lawyers',   lbl:'محامون',        ico:'fa-gavel',              clr:'#5B2FD4', col:'dal_users'},
  {id:'doctors',   lbl:'أطباء',         ico:'fa-user-md',            clr:'#0ea5e9', col:'dal_users'},
  {id:'restaurants',lbl:'مطاعم',        ico:'fa-utensils',           clr:'#f59e0b', col:'dal_users'},
  {id:'markets',   lbl:'أسواق',         ico:'fa-shopping-cart',      clr:'#10b981', col:'dal_users'},
  {id:'realestate',lbl:'عقارات',        ico:'fa-home',               clr:'#f97316', col:'dal_users'},
  {id:'beauty',    lbl:'تجميل',         ico:'fa-spa',                clr:'#ec4899', col:'dal_users'},
  {id:'cars',      lbl:'سيارات',        ico:'fa-car',                clr:'#3b82f6', col:'dal_users'},
  {id:'travel',    lbl:'سفر',           ico:'fa-plane-departure',    clr:'#8b5cf6', col:'dal_users'},
  {id:'sports',    lbl:'رياضة',         ico:'fa-dumbbell',           clr:'#ef4444', col:'dal_users'},
  {id:'education', lbl:'تعليم',         ico:'fa-graduation-cap',     clr:'#06b6d4', col:'dal_users'},
  {id:'hotels',    lbl:'فنادق',         ico:'fa-hotel',              clr:'#d97706', col:'dal_users'},
  {id:'pharmacy',  lbl:'صيدليات',       ico:'fa-pills',              clr:'#059669', col:'dal_users'},
  {id:'electronics',lbl:'إلكترونيات',  ico:'fa-laptop',             clr:'#64748b', col:'dal_users'},
  {id:'furniture', lbl:'مفروشات',       ico:'fa-couch',              clr:'#92400e', col:'dal_users'},
  {id:'mobiles',   lbl:'موبايلات',      ico:'fa-mobile-alt',         clr:'#1d4ed8', col:'dal_users'},
  {id:'salons',    lbl:'صالونات',       ico:'fa-cut',                clr:'#be185d', col:'dal_users'},
  {id:'taxis',     lbl:'سيارات أجرة',  ico:'fa-taxi',               clr:'#ca8a04', col:'dal_users'},
  {id:'clinics',   lbl:'عيادات',        ico:'fa-clinic-medical',     clr:'#0891b2', col:'dal_users'},
  {id:'teachers',  lbl:'مدرسين',        ico:'fa-chalkboard-teacher', clr:'#7c3aed', col:'dal_users'},
  {id:'fastfood',  lbl:'وجبات سريعة',  ico:'fa-hamburger',          clr:'#dc2626', col:'dal_users'},
];

// Map account type to category
const TYPE_TO_CAT = {
  lawyer:'lawyers', doctor:'doctors', restaurant:'restaurants',
  market:'markets', realestate:'realestate', beauty:'beauty',
  cars:'cars', travel:'travel', sports:'sports', education:'education',
  hotel:'hotels', pharmacy:'pharmacy', electronics:'electronics',
  furniture:'furniture', teacher:'teachers', clinic:'clinics', other:'fastfood',
};
const TYPE_LABELS = {
  user:'مستخدم',lawyer:'محامي',doctor:'طبيب',restaurant:'مطعم',
  market:'تاجر',realestate:'عقارات',beauty:'تجميل',cars:'سيارات',
  travel:'سفر',sports:'رياضة',education:'تعليم',hotel:'فندق',
  pharmacy:'صيدلاني',teacher:'مدرس',clinic:'طبيب',electronics:'إلكترونيات',
  furniture:'مفروشات',other:'أخرى',
};
const COLORS = ['#5B2FD4','#0ea5e9','#f59e0b','#10b981','#f97316','#ec4899','#3b82f6','#8b5cf6','#ef4444','#06b6d4','#d97706','#059669'];

// ==============================
// STATE
// ==============================
let CU = null;
let curView = 'home', prevViews = [];
let curCatId = null, allUsers = [], allPosts = [];
let favs = [], chatUnread = 0;
let curOTP = '', otpTmr = null, otpSec = 180;
let regData = {}, regLocation = null;
let selectedImgs = [], selectedCat = null, postType = 'offer';
let curChatUser = null, chatListener = null;
let srchTab = 'all', defInst = null;

// ==============================
// INIT
// ==============================
document.addEventListener('DOMContentLoaded', () => {
  favs = JSON.parse(localStorage.getItem('dal_favs') || '[]');
  setupOTPInputs();

  setTimeout(() => {
    document.getElementById('splash').classList.add('hide');
    const sv = localStorage.getItem('dal_user');
    if (sv) {
      try { CU = JSON.parse(sv); startApp(); }
      catch(e) { showAuth(); }
    } else {
      showAuth();
    }
  }, 2600);
});

function setupOTPInputs() {
  for (let i = 0; i < 6; i++) {
    const b = document.getElementById('o' + i);
    if (!b) continue;
    b.addEventListener('input', e => {
      const v = e.target.value.replace(/\D/g, '').slice(-1);
      e.target.value = v;
      e.target.classList.toggle('f', !!v);
      if (v && i < 5) document.getElementById('o' + (i + 1)).focus();
    });
    b.addEventListener('keydown', e => {
      if (e.key === 'Backspace' && !b.value && i > 0) document.getElementById('o' + (i - 1)).focus();
    });
  }
}

// ==============================
// AUTH
// ==============================
function showAuth() {
  document.getElementById('auth-wrap').classList.add('on');
  document.getElementById('app').style.display = 'none';
  showAS('sc-login');
}
function showAS(id) {
  document.querySelectorAll('.asc').forEach(s => s.classList.remove('on'));
  const el = document.getElementById(id);
  if (el) { el.classList.add('on'); el.scrollTop = 0; }
}

async function doLogin() {
  const ph = document.getElementById('l-ph').value.trim();
  const pw = document.getElementById('l-pw').value;
  let ok = true;
  if (!ph || ph.length < 10) { setFE('l-ph-e', 'رقم الهاتف غير صحيح'); ok = false; } else clrFE('l-ph-e');
  if (!pw || pw.length < 6) { setFE('l-pw-e', 'كلمة المرور قصيرة'); ok = false; } else clrFE('l-pw-e');
  if (!ok) return;
  const btn = document.getElementById('l-btn');
  setLd(btn, true, 'جاري الدخول...');
  try {
    const snap = await db.collection('dal_users').where('phone', '==', ph).limit(1).get();
    if (snap.empty) { setFE('l-ph-e', 'لا يوجد حساب بهذا الرقم'); setLd(btn, false); return; }
    const u = { id: snap.docs[0].id, ...snap.docs[0].data() };
    if (u.password !== hashPw(pw)) { setFE('l-pw-e', 'كلمة المرور غير صحيحة'); setLd(btn, false); return; }
    CU = u;
    localStorage.setItem('dal_user', JSON.stringify(u));
    setLd(btn, false);
    showToast('أهلاً ' + u.name.split(' ')[0] + ' 👋', 'ok');
    setTimeout(startApp, 600);
  } catch (err) {
    showToast('تعذر الاتصال، تحقق من الإنترنت', 'err');
    setLd(btn, false);
  }
}

function goS2() {
  const nm = document.getElementById('r-nm').value.trim();
  const ad = document.getElementById('r-ad').value.trim();
  const ph = document.getElementById('r-ph').value.trim();
  const tp = document.getElementById('r-tp').value;
  let ok = true;
  if (nm.split(' ').filter(Boolean).length < 2) { setFE('r-nm-e', 'يجب إدخال الاسم الثنائي على الأقل'); ok = false; } else clrFE('r-nm-e');
  if (!ad || ad.length < 4) { setFE('r-ad-e', 'يرجى إدخال العنوان'); ok = false; } else clrFE('r-ad-e');
  if (!ph || ph.length < 10) { setFE('r-ph-e', 'رقم الهاتف غير صحيح'); ok = false; } else clrFE('r-ph-e');
  if (!tp) { setFE('r-tp-e', 'يرجى اختيار نوع الحساب'); ok = false; } else clrFE('r-tp-e');
  if (!ok) return;
  regData = { name: nm, address: ad, phone: ph, type: tp, bio: document.getElementById('r-bio').value.trim() };
  if (regLocation) regData.location = regLocation;
  document.getElementById('r-s1').style.display = 'none';
  document.getElementById('r-s2').style.display = 'block';
  updSteps(2);
}
function backS1() { document.getElementById('r-s2').style.display = 'none'; document.getElementById('r-s1').style.display = 'block'; updSteps(1); }
function backS2() { document.getElementById('r-s2').style.display = 'block'; document.getElementById('r-s1').style.display = 'none'; updSteps(2); }

function updSteps(n) {
  for (let i = 1; i <= 3; i++) {
    const el = document.getElementById('st' + i); if (!el) continue;
    el.classList.toggle('done', i < n); el.classList.toggle('active', i === n);
    const sc = el.querySelector('.step-c');
    if (i < n) sc.innerHTML = '<i class="fas fa-check" style="font-size:12px"></i>';
    else if (i > n) sc.innerHTML = i + '';
    else if (i === 1) sc.innerHTML = '<i class="fas fa-user" style="font-size:12px"></i>';
  }
  const sl1 = document.getElementById('sl1'); if (sl1) sl1.style.background = n > 1 ? 'var(--S)' : 'var(--BDR)';
  const sl2 = document.getElementById('sl2'); if (sl2) sl2.style.background = n > 2 ? 'var(--S)' : 'var(--BDR)';
}

async function goS3() {
  const pw = document.getElementById('r-pw').value;
  const pw2 = document.getElementById('r-pw2').value;
  const trOk = document.getElementById('trw').classList.contains('ck');
  let ok = true;
  if (!pw || pw.length < 6) { setFE('r-pw-e', 'كلمة المرور يجب أن تكون 6 أحرف على الأقل'); ok = false; } else clrFE('r-pw-e');
  if (pw !== pw2) { setFE('r-pw2-e', 'كلمة المرور غير متطابقة'); ok = false; } else clrFE('r-pw2-e');
  if (!trOk) { setFE('tr-e', 'يجب الموافقة على الشروط والأحكام'); ok = false; } else clrFE('tr-e');
  if (!ok) return;
  try {
    const snap = await db.collection('dal_users').where('phone', '==', regData.phone).limit(1).get();
    if (!snap.empty) { setFE('r-ph-e', 'هذا الرقم مسجل مسبقاً'); backS1(); return; }
  } catch (e) {}
  regData.password = hashPw(pw);
  curOTP = String(Math.floor(100000 + Math.random() * 900000));
  document.getElementById('otp-ph').textContent = regData.phone;
  document.getElementById('demo-code').textContent = curOTP;
  sendWAOTP(regData.phone, curOTP);
  showAS('sc-otp');
  updSteps(3);
  startOTPTimer();
}

function sendWAOTP(ph, code) {
  let p = ph.replace(/\D/g, '');
  if (p.startsWith('0')) p = '964' + p.slice(1);
  const msg = encodeURIComponent(`مرحباً!\nرمز التحقق الخاص بتطبيق دليل الخدمات:\n\n*${code}*\n\nصالح 3 دقائق. لا تشاركه مع أحد. 🔐`);
  window.open(`https://wa.me/${p}?text=${msg}`, '_blank');
}
function resendOTP() {
  curOTP = String(Math.floor(100000 + Math.random() * 900000));
  document.getElementById('demo-code').textContent = curOTP;
  sendWAOTP(regData.phone, curOTP);
  otpSec = 180; startOTPTimer();
  document.getElementById('resend-btn').disabled = true;
  showToast('تم إعادة الإرسال عبر واتساب', 'info');
}
function startOTPTimer() {
  if (otpTmr) clearInterval(otpTmr);
  otpSec = 180; updOTPTimer();
  otpTmr = setInterval(() => { otpSec--; updOTPTimer(); if (otpSec <= 0) { clearInterval(otpTmr); const rb = document.getElementById('resend-btn'); if (rb) rb.disabled = false; } }, 1000);
}
function updOTPTimer() { const m = String(Math.floor(otpSec / 60)).padStart(2, '0'); const s = String(otpSec % 60).padStart(2, '0'); const el = document.getElementById('otp-cd'); if (el) el.textContent = m + ':' + s; }

async function verOTP() {
  const entered = [0, 1, 2, 3, 4, 5].map(i => document.getElementById('o' + i).value).join('');
  if (entered.length < 6) { showToast('أدخل الرمز كاملاً', 'err'); return; }
  if (entered !== curOTP) { showToast('الرمز غير صحيح', 'err'); shakeOTP(); return; }
  const btn = document.getElementById('v-btn');
  setLd(btn, true, 'إنشاء الحساب...');
  clearInterval(otpTmr);
  try {
    const catId = TYPE_TO_CAT[regData.type] || 'fastfood';
    const ref = await db.collection('dal_users').add({
      ...regData,
      catId,
      postsCount: 0,
      verified: true,
      createdAt: FS.serverTimestamp(),
    });
    CU = { id: ref.id, ...regData, catId };
    localStorage.setItem('dal_user', JSON.stringify(CU));
    setLd(btn, false);
    btn.style.background = 'linear-gradient(135deg,#059669,#10b981)';
    btn.innerHTML = '<i class="fas fa-check-circle"></i><span>تم إنشاء الحساب!</span>';
    showToast('مرحباً ' + regData.name.split(' ')[0] + ' 🎉', 'ok');
    setTimeout(startApp, 1200);
  } catch (err) {
    showToast('حدث خطأ، حاول مجدداً', 'err');
    setLd(btn, false);
  }
}
function shakeOTP() { document.querySelectorAll('.oi').forEach(b => { b.style.animation = 'pulse .3s ease'; b.style.borderColor = 'var(--R)'; setTimeout(() => { b.style.animation = ''; b.style.borderColor = ''; }, 400); }); }
function doLogout() { if (!confirm('هل تريد تسجيل الخروج؟')) return; if (chatListener) chatListener(); CU = null; localStorage.removeItem('dal_user'); document.getElementById('app').style.display = 'none'; showAuth(); showToast('تم تسجيل الخروج'); }

// ==============================
// LOCATION
// ==============================
function captureLocation(ctx) {
  if (!navigator.geolocation) { showToast('جهازك لا يدعم تحديد الموقع', 'err'); return; }
  const box = document.getElementById('reg-loc-box');
  if (box) { const act = document.getElementById('reg-loc-act'); act.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; }
  showToast('جاري تحديد موقعك...', 'info');
  navigator.geolocation.getCurrentPosition(pos => {
    const { latitude: lat, longitude: lng } = pos.coords;
    const locData = { lat, lng };
    reverseGeocode(lat, lng).then(addr => {
      locData.label = addr;
      if (ctx === 'reg') {
        regLocation = locData;
        const txt = document.getElementById('reg-loc-txt');
        if (txt) txt.textContent = addr;
        const act = document.getElementById('reg-loc-act');
        if (act) act.innerHTML = '<i class="fas fa-check" style="color:var(--S)"></i>';
      } else if (ctx === 'profile' && CU) {
        CU.location = locData;
        localStorage.setItem('dal_user', JSON.stringify(CU));
        db.collection('dal_users').doc(CU.id).update({ location: locData }).catch(() => {});
        const el = document.getElementById('pf-loc-txt');
        if (el) el.textContent = addr;
        const sel = document.getElementById('set-loc-txt');
        if (sel) sel.textContent = addr;
        document.getElementById('loc-modal').classList.remove('on');
        showToast('✓ تم تحديث موقعك', 'ok');
      }
    });
  }, err => {
    showToast('تعذر تحديد الموقع. تأكد من تفعيل GPS', 'err');
    const act = document.getElementById('reg-loc-act');
    if (act) act.innerHTML = '<i class="fas fa-crosshairs"></i>';
  }, { enableHighAccuracy: true, timeout: 10000 });
}

async function reverseGeocode(lat, lng) {
  try {
    const r = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&accept-language=ar`);
    const d = await r.json();
    const addr = d.address;
    return [addr.city || addr.town || addr.village || '', addr.state || ''].filter(Boolean).join('، ') || `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
  } catch (e) {
    return `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
  }
}

function openManualLoc() {
  document.getElementById('loc-modal').classList.remove('on');
  const addr = prompt('أدخل عنوانك:');
  if (addr && addr.trim()) {
    const locData = { label: addr.trim() };
    if (CU) {
      CU.location = locData;
      localStorage.setItem('dal_user', JSON.stringify(CU));
      db.collection('dal_users').doc(CU.id).update({ location: locData }).catch(() => {});
      const el = document.getElementById('pf-loc-txt'); if (el) el.textContent = addr.trim();
      const sel = document.getElementById('set-loc-txt'); if (sel) sel.textContent = addr.trim();
      showToast('✓ تم تحديث موقعك', 'ok');
    }
  }
}
function clearLocation() {
  document.getElementById('loc-modal').classList.remove('on');
  if (!CU) return;
  CU.location = null;
  localStorage.setItem('dal_user', JSON.stringify(CU));
  db.collection('dal_users').doc(CU.id).update({ location: null }).catch(() => {});
  const el = document.getElementById('pf-loc-txt'); if (el) el.textContent = 'أضف موقعك';
  const sel = document.getElementById('set-loc-txt'); if (sel) sel.textContent = 'لم يُضف موقع بعد';
  showToast('تم حذف الموقع');
}

// ==============================
// APP START
// ==============================
function startApp() {
  document.getElementById('auth-wrap').classList.remove('on');
  document.getElementById('app').style.display = 'block';
  updProfileUI();
  buildCatPicker();
  renderCats();
  loadRecentUsers();
  loadFeed();
  loadChatList();
  loadStats();
  prefillBooking();
  setTimeout(showAd, 3000);
  setTimeout(() => { if (defInst) { const p = document.getElementById('pwa'); p.style.display = 'flex'; setTimeout(() => p.classList.add('on'), 100); } }, 9000);
}

function updProfileUI() {
  if (!CU) return;
  const init = (CU.name || '؟').split(' ').filter(Boolean).map(w => w[0]).slice(0, 2).join('');
  const tl = TYPE_LABELS[CU.type] || 'مستخدم';
  const cat = CATS.find(c => c.id === (CU.catId || TYPE_TO_CAT[CU.type])) || CATS[0];
  document.getElementById('hav').textContent = init;
  document.getElementById('pf-av').textContent = init;
  document.getElementById('pf-av').style.background = `linear-gradient(135deg,${cat.clr},${cat.clr}aa)`;
  document.getElementById('pf-nm').textContent = CU.name || '';
  document.getElementById('pf-tp').innerHTML = `<i class="fas ${cat.ico}"></i><span>${tl}</span>`;
  document.getElementById('pf-ph').textContent = CU.phone || '';
  document.getElementById('h-nm').innerHTML = `أهلاً <span>${(CU.name || '').split(' ')[0]}</span> 👋`;
  document.getElementById('ps-favs').textContent = favs.length;
  const loc = CU.location;
  const locTxt = loc ? (loc.label || `${(loc.lat||0).toFixed(3)},${(loc.lng||0).toFixed(3)}`) : 'أضف موقعك';
  const el = document.getElementById('pf-loc-txt'); if (el) el.textContent = locTxt;
  const sel = document.getElementById('set-loc-txt'); if (sel) sel.textContent = loc ? locTxt : 'لم يُضف موقع بعد';
  prefillBooking();
}

function prefillBooking() {
  if (!CU) return;
  const n = document.getElementById('bk-n'); const p = document.getElementById('bk-p');
  if (n) { n.value = CU.name || ''; n.style.color = 'var(--T)'; }
  if (p) { p.value = CU.phone || ''; p.style.color = 'var(--T)'; }
  const ap = document.getElementById('ap-ph'); if (ap && !ap.value) ap.value = CU.phone || '';
}

async function loadStats() {
  try {
    const [uSnap, pSnap] = await Promise.all([
      db.collection('dal_users').get(),
      db.collection('dal_posts').get()
    ]);
    const su = document.getElementById('sc-users'); if (su) su.textContent = uSnap.size + '+';
    const sp = document.getElementById('sc-posts'); if (sp) sp.textContent = pSnap.size + '';
  } catch (e) {}
}

// ==============================
// VIEWS
// ==============================
function showView(name, push = true) {
  const mainViews = ['home', 'feed', 'chat-list', 'favorites', 'profile'];
  document.querySelectorAll('.view').forEach(v => v.classList.remove('on'));
  const el = document.getElementById('v-' + name); if (!el) return;
  el.classList.add('on');
  if (push && curView !== name) prevViews.push(curView);
  curView = name;
  // Nav
  document.querySelectorAll('.navit').forEach(b => {
    b.classList.toggle('on', b.dataset.v === name);
    if (b.dataset.v === 'favorites') b.querySelector('i').className = (name === 'favorites' ? 'fas' : 'far') + ' fa-heart';
  });
  // Header
  const hback = document.getElementById('hback');
  const hlogo = document.getElementById('hlogo');
  const htit = document.getElementById('htit');
  if (mainViews.includes(name)) { hback.classList.remove('on'); hlogo.style.display = 'flex'; htit.textContent = ''; }
  else { hback.classList.add('on'); hlogo.style.display = 'none'; }
  if (name === 'list') htit.textContent = curCatId ? (CATS.find(c => c.id === curCatId)?.lbl || '') : '';
  else if (name === 'user-profile') htit.textContent = '';
  else if (!mainViews.includes(name)) htit.textContent = '';
  // FAB
  const fab = document.getElementById('fab');
  fab.classList.toggle('hide', ['chat-list', 'favorites', 'detail', 'user-profile'].includes(name));
  // Load data
  if (name === 'favorites') renderFavView();
  if (name === 'profile') { loadMyPosts(); updProfileUI(); }
  if (name === 'chat-list') loadChatList();
  if (name === 'feed') loadFeed();
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function goBack() {
  if (prevViews.length > 0) {
    const prev = prevViews.pop();
    showView(prev, false);
  } else {
    showView('home', false);
  }
}

// ==============================
// CATEGORIES — display users
// ==============================
function renderCats() {
  const g = document.getElementById('cgrid');
  g.innerHTML = CATS.map((c, i) => `<button class="ctile" style="animation-delay:${i * .04}s" onclick="openCat('${c.id}')"><div class="cico" style="background:${c.clr}"><i class="fas ${c.ico}"></i></div><span class="clbl">${c.lbl}</span></button>`).join('');
  // Load counts per category
  db.collection('dal_users').get().then(snap => {
    const counts = {};
    snap.docs.forEach(d => { const cat = d.data().catId; if (cat) counts[cat] = (counts[cat] || 0) + 1; });
    document.querySelectorAll('.ctile').forEach(tile => {
      const id = tile.getAttribute('onclick').match(/'([^']+)'/)[1];
      const c = counts[id] || 0;
      if (c > 0) {
        const s = document.createElement('span');
        s.className = 'ccount';
        s.textContent = c;
        tile.appendChild(s);
      }
    });
  }).catch(() => {});
}

async function openCat(catId) {
  curCatId = catId;
  const cat = CATS.find(c => c.id === catId);
  allUsers = [];
  showView('list');
  document.getElementById('l-inp').value = '';
  const grid = document.getElementById('ugrid');
  grid.innerHTML = `<div class="sp-wrap" style="grid-column:1/-1"><div class="sp"></div><span class="sptxt">جاري تحميل الأعضاء...</span></div>`;
  try {
    const snap = await db.collection('dal_users').where('catId', '==', catId).get();
    allUsers = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    renderUsers(allUsers);
  } catch (err) {
    grid.innerHTML = `<div class="empty-st" style="grid-column:1/-1"><i class="fas fa-wifi-slash"></i><p>تعذر التحميل</p></div>`;
  }
}

function renderUsers(users) {
  const grid = document.getElementById('ugrid');
  if (!users || !users.length) {
    grid.innerHTML = `<div class="empty-st" style="grid-column:1/-1"><i class="fas ${CATS.find(c => c.id === curCatId)?.ico || 'fa-users'}"></i><p>لا يوجد أعضاء في هذه الفئة بعد</p><span>كن أول من ينضم!</span></div>`;
    return;
  }
  const cat = CATS.find(c => c.id === curCatId) || CATS[0];
  grid.innerHTML = users.map((u, i) => buildUserCard(u, cat, i)).join('');
}

function buildUserCard(u, cat, idx = 0) {
  const init = (u.name || '؟').split(' ').filter(Boolean).map(w => w[0]).slice(0, 2).join('');
  const tl = TYPE_LABELS[u.type] || 'عضو';
  const loc = u.location ? `<div class="uc-adr"><i class="fas fa-map-marker-alt" style="color:var(--P);font-size:10px"></i>${u.location.label || ''}</div>` : '';
  const isOwn = CU && u.id === CU.id;
  return `<div class="ucard" style="animation-delay:${idx * .05}s">
    <div class="ucav" style="background:linear-gradient(135deg,${cat.clr},${cat.clr}aa)" onclick="openUserProfile('${u.id}')">${init}</div>
    <div class="uc-info" onclick="openUserProfile('${u.id}')">
      <div class="uc-nm">${u.name || 'عضو'}</div>
      <div class="uc-type" style="background:${cat.clr}22;color:${cat.clr}"><i class="fas ${cat.ico}" style="font-size:9px"></i>${tl}</div>
      ${loc}
      ${u.bio ? `<div style="font-size:11px;color:var(--T3);margin-top:3px;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical">${u.bio}</div>` : ''}
    </div>
    <div class="uc-actions">
      ${!isOwn ? `<button class="uc-act-btn uab-chat" onclick="startChat('${u.id}','${encodeURIComponent(u.name || '')}','${cat.clr}','${u.phone || ''}')" title="رسالة"><i class="fas fa-comment-dots"></i></button>` : ''}
      ${u.phone ? `<button class="uc-act-btn uab-call" onclick="window.open('tel:${u.phone}')" title="اتصال"><i class="fas fa-phone"></i></button>` : ''}
      ${u.phone ? `<button class="uc-act-btn uab-wa" onclick="openWA('${u.phone}')" title="واتساب"><i class="fab fa-whatsapp"></i></button>` : ''}
    </div>
  </div>`;
}

function filterUsers(q) {
  const sort = document.getElementById('l-sort').value;
  let filtered = q.trim()
    ? allUsers.filter(u => (u.name || '').toLowerCase().includes(q.toLowerCase()) || (u.address || '').toLowerCase().includes(q.toLowerCase()) || (u.bio || '').toLowerCase().includes(q.toLowerCase()))
    : [...allUsers];
  if (sort === 'new') filtered.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
  else if (sort === 'name') filtered.sort((a, b) => (a.name || '').localeCompare(b.name || '', 'ar'));
  else if (sort === 'location' && CU?.location?.lat) {
    filtered.sort((a, b) => {
      const da = dist(CU.location, a.location); const db2 = dist(CU.location, b.location);
      return da - db2;
    });
  }
  renderUsers(filtered);
}
function dist(a, b) {
  if (!a || !b || !a.lat || !b.lat) return 9999;
  const dx = (a.lat - b.lat) * 111; const dy = (a.lng - b.lng) * 111;
  return Math.sqrt(dx * dx + dy * dy);
}

// ==============================
// USER PUBLIC PROFILE
// ==============================
async function openUserProfile(userId) {
  showView('user-profile');
  const av = document.getElementById('upp-av');
  const nm = document.getElementById('upp-nm');
  const tp = document.getElementById('upp-type');
  const loc = document.getElementById('upp-loc');
  const acts = document.getElementById('upp-acts');
  const postsEl = document.getElementById('upp-posts-list');
  av.textContent = '...'; nm.textContent = ''; tp.innerHTML = ''; acts.innerHTML = '';
  postsEl.innerHTML = `<div class="sp-wrap"><div class="sp" style="width:30px;height:30px;border-width:2px"></div></div>`;
  try {
    const doc = await db.collection('dal_users').doc(userId).get();
    if (!doc.exists) { showToast('لم يتم العثور على الحساب', 'err'); goBack(); return; }
    const u = { id: doc.id, ...doc.data() };
    const cat = CATS.find(c => c.id === u.catId) || CATS[0];
    const init = (u.name || '؟').split(' ').filter(Boolean).map(w => w[0]).slice(0, 2).join('');
    const tl = TYPE_LABELS[u.type] || 'عضو';
    document.getElementById('htit').textContent = u.name || '';
    av.textContent = init;
    av.style.background = `linear-gradient(135deg,${cat.clr},${cat.clr}aa)`;
    nm.textContent = u.name || 'مستخدم';
    tp.innerHTML = `<i class="fas ${cat.ico}"></i><span>${tl}</span>`;
    tp.style.background = `${cat.clr}30`;
    tp.style.color = cat.clr;
    document.getElementById('upp-hero').style.background = `linear-gradient(155deg,${cat.clr}dd,${cat.clr})`;
    if (u.location?.label) {
      loc.style.display = 'flex';
      loc.querySelector('span').textContent = u.location.label;
    } else {
      loc.style.display = 'none';
    }
    if (u.bio) {
      document.getElementById('upp-bio-card').style.display = 'block';
      document.getElementById('upp-bio').textContent = u.bio;
    } else {
      document.getElementById('upp-bio-card').style.display = 'none';
    }
    // Joined date
    const joined = u.createdAt?.toDate ? new Date(u.createdAt.toDate()).toLocaleDateString('ar-IQ', { year: 'numeric', month: 'short' }) : '—';
    document.getElementById('upp-joined').textContent = joined;
    // Actions
    const isOwn = CU && u.id === CU.id;
    let btns = '';
    if (!isOwn) {
      btns += `<button class="upp-act uppa-chat" onclick="startChat('${u.id}','${encodeURIComponent(u.name || '')}','${cat.clr}','${u.phone || ''}')"><i class="fas fa-comment-dots"></i>مراسلة</button>`;
    }
    if (u.phone) {
      btns += `<button class="upp-act uppa-call" onclick="window.open('tel:${u.phone}')"><i class="fas fa-phone"></i>اتصال</button>`;
      btns += `<button class="upp-act uppa-wa" onclick="openWA('${u.phone}')"><i class="fab fa-whatsapp"></i>واتساب</button>`;
    }
    acts.innerHTML = btns;
    // Load posts
    const pSnap = await db.collection('dal_posts').where('userId', '==', userId).orderBy('createdAt', 'desc').get();
    const posts = pSnap.docs.map(d => ({ id: d.id, ...d.data() }));
    document.getElementById('upp-posts').textContent = posts.length;
    if (!posts.length) {
      postsEl.innerHTML = `<div class="empty-st" style="padding:30px 0"><i class="fas fa-th"></i><p>لا توجد منشورات</p></div>`;
    } else {
      postsEl.innerHTML = posts.map((p, i) => buildPostCard(p, i)).join('');
    }
  } catch (err) {
    showToast('حدث خطأ', 'err');
  }
}

// ==============================
// FEATURED / RECENT USERS
// ==============================
async function loadRecentUsers() {
  const sc = document.getElementById('fsc');
  try {
    const snap = await db.collection('dal_users').where('type', '!=', 'user').orderBy('type').orderBy('createdAt', 'desc').limit(10).get();
    if (snap.empty) { sc.innerHTML = '<div style="padding:30px 20px;color:var(--T3);font-size:13px">لا توجد بيانات بعد</div>'; return; }
    sc.innerHTML = snap.docs.map((d, i) => {
      const u = { id: d.id, ...d.data() };
      const cat = CATS.find(c => c.id === u.catId) || CATS[0];
      const init = (u.name || '؟').split(' ').filter(Boolean).map(w => w[0]).slice(0, 2).join('');
      return `<div class="fcard" style="animation-delay:${i * .06}s" onclick="openUserProfile('${u.id}')">
        <div class="fph" style="background:linear-gradient(135deg,${cat.clr},${cat.clr}bb)">${init}</div>
        <div class="fbdy">
          <div class="fnm">${u.name || '—'}</div>
          <div class="fadr">${u.address || ''}</div>
          <div class="fbdg"><i class="fas ${cat.ico}" style="font-size:9px"></i>${cat.lbl}</div>
        </div>
      </div>`;
    }).join('');
  } catch (e) {
    sc.innerHTML = '<div style="padding:30px 20px;color:var(--T3);font-size:13px">تعذر التحميل</div>';
  }
}

// ==============================
// FEED / POSTS
// ==============================
async function loadFeed() {
  const list = document.getElementById('feed-list');
  list.innerHTML = `<div class="sp-wrap"><div class="sp"></div><span class="sptxt">جاري التحميل...</span></div>`;
  try {
    const snap = await db.collection('dal_posts').orderBy('createdAt', 'desc').limit(60).get();
    allPosts = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    buildFeedFilters();
    renderFeed(allPosts);
    const pc = document.getElementById('sc-posts'); if (pc) pc.textContent = allPosts.length + '';
  } catch (e) {
    list.innerHTML = `<div class="empty-st"><i class="fas fa-wifi-slash"></i><p>تعذر التحميل</p><button onclick="loadFeed()" style="margin-top:14px;padding:10px 22px;border-radius:12px;background:var(--P);color:white;border:none;font-family:Tajawal,sans-serif;font-size:14px;font-weight:700;cursor:pointer">إعادة المحاولة</button></div>`;
  }
}

function buildFeedFilters() {
  const bar = document.getElementById('feed-filters');
  const usedCats = [...new Set(allPosts.map(p => p.catId).filter(Boolean))];
  let btns = `<button class="ffbtn on" onclick="filterFeed('all',this)">الكل</button>`;
  btns += `<button class="ffbtn" onclick="filterFeed('offer',this)">عروض خدمة ✅</button>`;
  btns += `<button class="ffbtn" onclick="filterFeed('request',this)">طلب خدمة 🔍</button>`;
  btns += usedCats.map(cid => {
    const cat = CATS.find(c => c.id === cid); if (!cat) return '';
    return `<button class="ffbtn" onclick="filterFeed('${cid}',this)"><i class="fas ${cat.ico}" style="margin-left:5px;font-size:11px;color:${cat.clr}"></i>${cat.lbl}</button>`;
  }).join('');
  bar.innerHTML = btns;
}

function filterFeed(filter, btn) {
  document.querySelectorAll('.ffbtn').forEach(b => b.classList.remove('on'));
  if (btn) btn.classList.add('on');
  let filtered;
  if (filter === 'all') filtered = allPosts;
  else if (filter === 'offer') filtered = allPosts.filter(p => p.postType !== 'request');
  else if (filter === 'request') filtered = allPosts.filter(p => p.postType === 'request');
  else filtered = allPosts.filter(p => p.catId === filter);
  renderFeed(filtered);
}

function renderFeed(posts) {
  const list = document.getElementById('feed-list');
  if (!posts || !posts.length) {
    list.innerHTML = `<div class="empty-st"><i class="fas fa-rss"></i><p>لا توجد منشورات</p><span>كن أول من ينشر!</span><button onclick="openAddPost()" style="margin-top:16px;padding:12px 28px;border-radius:14px;background:var(--P);color:white;border:none;font-family:Tajawal,sans-serif;font-size:15px;font-weight:900;cursor:pointer"><i class="fas fa-plus" style="margin-left:8px"></i>إضافة منشور</button></div>`;
    return;
  }
  list.innerHTML = posts.map((p, i) => buildPostCard(p, i)).join('');
}

function buildPostCard(p, idx = 0) {
  const cat = CATS.find(c => c.id === p.catId) || CATS[0];
  const init = (p.userName || 'م').split(' ').filter(Boolean).map(w => w[0]).slice(0, 2).join('');
  const avColor = COLORS[(p.userId || '').length % COLORS.length] || 'var(--P)';
  const tl = TYPE_LABELS[p.userType] || 'مستخدم';
  const ts = p.createdAt?.toDate ? timeAgo(p.createdAt.toDate()) : 'منذ قليل';
  const likes = JSON.parse(localStorage.getItem('dal_likes') || '{}');
  const isLiked = likes[p.id];
  const likeCount = p.likes || 0;
  const isOwn = CU && p.userId === CU.id;
  const isReq = p.postType === 'request';

  // Images slider
  let imgsHTML = '';
  if (p.images && p.images.length > 0) {
    const slides = p.images.map(url => `<div class="pslide"><img src="${url}" alt="" loading="lazy" onerror="this.src='https://via.placeholder.com/400x240/E6E0FF/5B2FD4?text=صورة'"></div>`).join('');
    const dots = p.images.length > 1 ? `<div class="pdots" id="dots-${p.id}">${p.images.map((_, i) => `<div class="pdot ${i === 0 ? 'on' : ''}"></div>`).join('')}</div>` : '';
    imgsHTML = `<div class="pimgs"><div class="pimgs-track" id="slider-${p.id}" onscroll="updDots('${p.id}',${p.images.length})">${slides}</div>${dots}</div>`;
  }

  // Actions
  const actions = [];
  if (p.phone) actions.push(`<a href="tel:${p.phone}" class="pabtn pa-call"><i class="fas fa-phone"></i><span>اتصال</span></a>`);
  const waNum = p.whatsapp || p.phone;
  if (waNum) { let w = waNum.replace(/\D/g, ''); if (w.startsWith('0')) w = '964' + w.slice(1); actions.push(`<a href="https://wa.me/${w}" class="pabtn pa-wa" target="_blank"><i class="fab fa-whatsapp"></i><span>واتساب</span></a>`); }
  if (p.instagram) actions.push(`<a href="${p.instagram}" class="pabtn pa-ig" target="_blank"><i class="fab fa-instagram"></i><span>انستغرام</span></a>`);
  if (p.facebook) actions.push(`<a href="${p.facebook}" class="pabtn pa-fb" target="_blank"><i class="fab fa-facebook-f"></i><span>فيسبوك</span></a>`);
  if (!isOwn && p.userId) actions.push(`<button class="pabtn pa-chat" onclick="startChat('${p.userId}','${encodeURIComponent(p.userName || '')}','${cat.clr}','${p.phone || ''}')"><i class="fas fa-comment-dots"></i><span>مراسلة</span></button>`);

  // Post type badge
  const typeBadge = isReq
    ? `<span class="ptype-badge ptb-req"><i class="fas fa-search" style="font-size:9px;margin-left:3px"></i>طلب خدمة</span>`
    : `<span class="ptype-badge ptb-offer"><i class="fas fa-check-circle" style="font-size:9px;margin-left:3px"></i>عرض خدمة</span>`;

  const menuBtn = isOwn ? `<button class="pmenu" onclick="postMenu('${p.id}')"><i class="fas fa-ellipsis-v"></i></button>` : '<div style="width:32px"></div>';

  return `<div class="pcard" style="animation-delay:${idx * .05}s" id="pcard-${p.id}">
    <div class="phead">
      <div class="pav" style="background:${avColor}" onclick="openUserProfile('${p.userId || ''}')" title="عرض الملف الشخصي">${init}</div>
      <div class="puinfo" onclick="openUserProfile('${p.userId || ''}')">
        <div class="punm">${p.userName || 'مستخدم'}</div>
        <div class="pumeta">
          <span class="putype" style="background:${cat.clr}">${tl}</span>
          ${typeBadge}
          <span class="ptime">• ${ts}</span>
        </div>
      </div>
      ${menuBtn}
    </div>
    ${imgsHTML}
    <div class="pbody">
      <div class="ptit">${p.title || 'منشور'}</div>
      <div class="pcat-tag" style="background:${cat.clr}22;color:${cat.clr}"><i class="fas ${cat.ico}" style="font-size:10px"></i>${cat.lbl}</div>
      ${p.description ? `<div class="pdesc">${p.description}</div>` : ''}
      ${p.address ? `<div class="pinfo-row"><i class="fas fa-map-marker-alt"></i><span>${p.address}</span></div>` : ''}
      ${p.phone ? `<div class="pinfo-row"><i class="fas fa-phone"></i><span>${p.phone}</span></div>` : ''}
    </div>
    ${actions.length ? `<div class="pactions">${actions.join('')}</div>` : ''}
    <div class="pfoot">
      <button class="plike ${isLiked ? 'on' : ''}" onclick="toggleLike('${p.id}',${likeCount},this)" id="like-${p.id}"><i class="${isLiked ? 'fas' : 'far'} fa-heart"></i><span id="lc-${p.id}">${likeCount}</span></button>
      <button class="pshr" onclick="sharePost('${p.id}','${(p.title || '').replace(/'/g, "\\'")}')"><i class="fas fa-share-alt"></i><span>مشاركة</span></button>
    </div>
  </div>`;
}

function updDots(postId, count) {
  const track = document.getElementById('slider-' + postId);
  const dotsEl = document.getElementById('dots-' + postId);
  if (!track || !dotsEl) return;
  const idx = Math.round(track.scrollLeft / track.offsetWidth);
  dotsEl.querySelectorAll('.pdot').forEach((d, i) => d.classList.toggle('on', i === idx));
}

async function toggleLike(postId, curLikes, btn) {
  const stored = JSON.parse(localStorage.getItem('dal_likes') || '{}');
  const isLiked = stored[postId];
  const newLikes = isLiked ? Math.max(0, curLikes - 1) : curLikes + 1;
  stored[postId] = !isLiked;
  localStorage.setItem('dal_likes', JSON.stringify(stored));
  btn.classList.toggle('on', !isLiked);
  btn.querySelector('i').className = (!isLiked ? 'fas' : 'far') + ' fa-heart';
  const lc = document.getElementById('lc-' + postId); if (lc) lc.textContent = newLikes;
  try { await db.collection('dal_posts').doc(postId).update({ likes: newLikes }); } catch (e) {}
}

function sharePost(id, title) {
  const url = location.href + '#post-' + id;
  if (navigator.share) navigator.share({ title, url });
  else navigator.clipboard.writeText(url).then(() => showToast('تم نسخ رابط المنشور', 'ok'));
}

function postMenu(postId) {
  if (confirm('هل تريد حذف هذا المنشور؟')) {
    db.collection('dal_posts').doc(postId).delete().then(() => {
      const el = document.getElementById('pcard-' + postId);
      if (el) { el.style.cssText = 'transform:scale(0);opacity:0;transition:.3s ease;height:0;overflow:hidden;margin:0;padding:0;'; setTimeout(() => el.remove(), 300); }
      showToast('تم حذف المنشور', 'ok');
      loadMyPosts();
    }).catch(() => showToast('تعذر الحذف', 'err'));
  }
}

function timeAgo(date) {
  const s = Math.floor((Date.now() - date) / 1000);
  if (s < 60) return 'منذ ثوانٍ';
  if (s < 3600) return `منذ ${Math.floor(s / 60)} د`;
  if (s < 86400) return `منذ ${Math.floor(s / 3600)} س`;
  return `منذ ${Math.floor(s / 86400)} يوم`;
}

// ==============================
// ADD POST
// ==============================
function buildCatPicker() {
  const g = document.getElementById('cpick');
  g.innerHTML = CATS.map(c => `<button class="cpbtn" data-id="${c.id}" onclick="selCat('${c.id}',this)"><i class="fas ${c.ico}" style="margin-left:4px;font-size:11px;color:${c.clr}"></i>${c.lbl}</button>`).join('');
}
function selCat(id, btn) {
  selectedCat = id;
  document.querySelectorAll('.cpbtn').forEach(b => b.classList.remove('on'));
  btn.classList.add('on');
  clrFE('ap-cat-e');
}
function setPostType(type, btn) {
  postType = type;
  document.getElementById('apt-offer').classList.toggle('on', type === 'offer');
  document.getElementById('apt-req').classList.toggle('on', type === 'request');
}

function openAddPost() {
  if (!CU) { showToast('يجب تسجيل الدخول أولاً', 'err'); return; }
  document.getElementById('ap-ov').classList.add('on');
  document.body.style.overflow = 'hidden';
  const ph = document.getElementById('ap-ph'); if (ph && !ph.value) ph.value = CU.phone || '';
  // Pre-select user's own category
  if (CU.catId) {
    const btn = document.querySelector(`.cpbtn[data-id="${CU.catId}"]`);
    if (btn && !selectedCat) { selectedCat = CU.catId; btn.classList.add('on'); }
  }
}
function closeAddPost() {
  document.getElementById('ap-ov').classList.remove('on');
  document.body.style.overflow = '';
}
function handleImgs(e) { addImgFiles([...e.target.files]); e.target.value = ''; }
function handleDrop(e) { e.preventDefault(); document.getElementById('imgu-area').classList.remove('drag'); addImgFiles([...e.dataTransfer.files].filter(f => f.type.startsWith('image/'))); }
function addImgFiles(files) {
  const rem = 2 - selectedImgs.length;
  const toAdd = files.slice(0, rem);
  if (files.length > rem) showToast(`الحد الأقصى صورتان (تم إضافة ${toAdd.length})`, 'info');
  toAdd.forEach(f => {
    const reader = new FileReader();
    reader.onload = ev => { selectedImgs.push({ file: f, url: ev.target.result }); renderImgPreview(); };
    reader.readAsDataURL(f);
  });
}
function renderImgPreview() {
  const prev = document.getElementById('imgprev');
  const hint = document.getElementById('img-hint');
  prev.innerHTML = selectedImgs.map((img, i) => `<div class="ipitem"><img src="${img.url}"><button class="ipdel" onclick="delImg(${i})"><i class="fas fa-times"></i></button></div>`).join('');
  if (hint) hint.innerHTML = selectedImgs.length === 0 ? '<span style="color:var(--T3)">لم تُضف صور</span>' : selectedImgs.length === 1 ? '<span style="color:var(--S)">✓ صورة واحدة — يمكنك إضافة ثانية</span>' : '<span style="color:var(--S)">✓ صورتان — الحد الأقصى</span>';
  const area = document.getElementById('imgu-area'); if (area) area.style.opacity = selectedImgs.length >= 2 ? '.5' : '1';
}
function delImg(i) { selectedImgs.splice(i, 1); renderImgPreview(); }

async function submitPost() {
  const title = document.getElementById('ap-title').value.trim();
  const addr = document.getElementById('ap-addr').value.trim();
  const ph = document.getElementById('ap-ph').value.trim();
  const desc = document.getElementById('ap-desc').value.trim();
  const ig = document.getElementById('ap-ig').value.trim();
  const fb = document.getElementById('ap-fb').value.trim();
  const wa = document.getElementById('ap-wa').value.trim();
  let ok = true;
  if (!selectedCat) { setFE('ap-cat-e', 'يرجى اختيار الفئة'); ok = false; } else clrFE('ap-cat-e');
  if (!title) { setFE('ap-tit-e', 'يرجى إدخال العنوان'); ok = false; } else clrFE('ap-tit-e');
  if (!addr) { setFE('ap-adr-e', 'يرجى إدخال الموقع'); ok = false; } else clrFE('ap-adr-e');
  if (!ph || ph.length < 10) { setFE('ap-ph-e', 'يرجى إدخال رقم هاتف صحيح'); ok = false; } else clrFE('ap-ph-e');
  if (!desc) { setFE('ap-dsc-e', 'يرجى كتابة وصف'); ok = false; } else clrFE('ap-dsc-e');
  if (!ok) return;
  const btn = document.getElementById('ap-sub');
  setLd(btn, true, 'جاري النشر...');
  try {
    let imageUrls = [];
    if (selectedImgs.length > 0) {
      document.getElementById('upwrap').style.display = 'block';
      const fill = document.getElementById('upfill');
      for (let i = 0; i < selectedImgs.length; i++) {
        const img = selectedImgs[i];
        const ref = storage.ref(`posts/${CU.id}/${Date.now()}_${i}_${img.file.name}`);
        const snap = await ref.put(img.file);
        const url = await snap.ref.getDownloadURL();
        imageUrls.push(url);
        if (fill) fill.style.width = `${Math.round(((i + 1) / selectedImgs.length) * 100)}%`;
      }
    }
    await db.collection('dal_posts').add({
      userId: CU.id, userName: CU.name || 'مستخدم', userType: CU.type || 'user',
      catId: selectedCat, postType,
      title, address: addr, phone: ph, whatsapp: wa || ph,
      description: desc, instagram: ig || null, facebook: fb || null,
      images: imageUrls, likes: 0,
      createdAt: FS.serverTimestamp()
    });
    // Reset
    selectedImgs = []; selectedCat = null; postType = 'offer';
    ['ap-title', 'ap-addr', 'ap-ph', 'ap-wa', 'ap-desc', 'ap-ig', 'ap-fb'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
    document.querySelectorAll('.cpbtn').forEach(b => b.classList.remove('on'));
    document.getElementById('imgprev').innerHTML = '';
    const hint = document.getElementById('img-hint'); if (hint) hint.innerHTML = '';
    document.getElementById('upwrap').style.display = 'none';
    document.getElementById('apt-offer').classList.add('on');
    document.getElementById('apt-req').classList.remove('on');
    closeAddPost();
    showToast('✓ تم نشر المنشور بنجاح!', 'ok');
    loadFeed();
    loadMyPosts();
    loadStats();
    setTimeout(() => showView('feed'), 500);
  } catch (err) {
    console.error(err);
    showToast('حدث خطأ أثناء النشر', 'err');
    document.getElementById('upwrap').style.display = 'none';
  }
  setLd(btn, false);
  btn.innerHTML = '<i class="fas fa-paper-plane"></i><span>نشر المنشور</span>';
}

// ==============================
// PROFILE - MY POSTS
// ==============================
async function loadMyPosts() {
  if (!CU) return;
  const grid = document.getElementById('my-posts');
  if (!grid) return;
  grid.innerHTML = `<div class="sp-wrap" style="grid-column:1/-1"><div class="sp" style="width:30px;height:30px;border-width:2px"></div></div>`;
  try {
    const snap = await db.collection('dal_posts').where('userId', '==', CU.id).orderBy('createdAt', 'desc').get();
    const posts = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    document.getElementById('ps-posts').textContent = posts.length;
    if (!posts.length) {
      grid.innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:40px 20px"><i class="fas fa-th-large" style="font-size:40px;color:var(--BDR);display:block;margin-bottom:12px"></i><p style="font-size:14px;font-weight:700;color:var(--T2)">لا توجد منشورات بعد</p><button onclick="openAddPost()" style="margin-top:12px;padding:10px 22px;border-radius:12px;background:var(--P);color:white;border:none;font-family:Tajawal,sans-serif;font-size:14px;font-weight:900;cursor:pointer"><i class="fas fa-plus" style="margin-left:6px"></i>إضافة أول منشور</button></div>`;
      return;
    }
    grid.innerHTML = posts.map((p, i) => {
      const cat = CATS.find(c => c.id === p.catId) || CATS[0];
      const img = p.images && p.images[0];
      return `<div class="mpc" style="animation-delay:${i * .05}s" onclick="openUserProfile('${CU.id}')">
        ${img ? `<img src="${img}" alt="">` : `<div style="width:100%;height:100%;background:${cat.clr};display:flex;align-items:center;justify-content:center;font-size:36px;color:rgba(255,255,255,.7)"><i class="fas ${cat.ico}"></i></div>`}
        <div class="mpc-overlay"><div class="mpc-title">${p.title || 'منشور'}</div></div>
      </div>`;
    }).join('');
  } catch (e) {
    grid.innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:40px 20px;color:var(--T3)">تعذر التحميل</div>`;
  }
}

function switchTab(tab) {
  ['posts', 'fav', 'set'].forEach(t => {
    document.getElementById('tc-' + t).style.display = t === tab ? 'block' : 'none';
    document.getElementById('ptab-' + t).classList.toggle('on', t === tab);
  });
  if (tab === 'fav') renderFavInProfile();
}

// ==============================
// FAVORITES
// ==============================
function toggleFav(id, catId, name, image, btn) {
  const cat = CATS.find(c => c.id === catId) || CATS[0];
  const idx = favs.findIndex(f => f.id === id && f.catId === catId);
  if (idx >= 0) { favs.splice(idx, 1); btn.classList.remove('on'); btn.querySelector('i').className = 'far fa-heart'; showToast('تمت إزالة المفضلة'); }
  else { favs.push({ id, catId, name, image, clr: cat.clr, ico: cat.ico, lbl: cat.lbl }); btn.classList.add('on'); btn.querySelector('i').className = 'fas fa-heart'; showToast('❤️ تمت الإضافة للمفضلة', 'ok'); }
  localStorage.setItem('dal_favs', JSON.stringify(favs));
  document.getElementById('ps-favs').textContent = favs.length;
}

function renderFavView() {
  const g = document.getElementById('fav-igrid2'); if (!g) return;
  if (!favs.length) { g.innerHTML = `<div class="empty-st" style="grid-column:1/-1"><i class="far fa-heart"></i><p>لا توجد مفضلة</p><span>اضغط ❤️ لإضافة خدمة</span></div>`; return; }
  g.innerHTML = favs.map((fav, i) => {
    const cat = CATS.find(c => c.id === fav.catId) || CATS[0];
    return `<div class="icard" style="animation-delay:${i * .05}s" onclick="openUserProfile('${fav.id}')"><div style="position:relative"><div class="icph" style="background:${cat.clr}"><i class="fas ${cat.ico}"></i></div><button class="favbtn on" onclick="event.stopPropagation();removeFav('${fav.id}','${fav.catId}',this.closest('.icard'))"><i class="fas fa-heart"></i></button></div><div class="icbdy"><div class="icnm">${fav.name || '—'}</div><div class="icbdg"><i class="fas ${cat.ico}" style="font-size:9px"></i>${cat.lbl}</div></div></div>`;
  }).join('');
}

function renderFavInProfile() {
  const g = document.getElementById('fav-igrid'); if (!g) return;
  if (!favs.length) { g.innerHTML = `<div class="empty-st" style="grid-column:1/-1"><i class="far fa-heart"></i><p>لا توجد مفضلة</p></div>`; return; }
  g.innerHTML = favs.map((fav, i) => {
    const cat = CATS.find(c => c.id === fav.catId) || CATS[0];
    return `<div class="icard" style="animation-delay:${i * .05}s" onclick="openUserProfile('${fav.id}')"><div style="position:relative"><div class="icph" style="background:${cat.clr}"><i class="fas ${cat.ico}"></i></div></div><div class="icbdy"><div class="icnm">${fav.name || '—'}</div><div class="icbdg"><i class="fas ${cat.ico}" style="font-size:9px"></i>${cat.lbl}</div></div></div>`;
  }).join('');
}

function removeFav(id, catId, card) {
  favs = favs.filter(f => !(f.id === id && f.catId === catId));
  localStorage.setItem('dal_favs', JSON.stringify(favs));
  document.getElementById('ps-favs').textContent = favs.length;
  card.style.cssText = 'transform:scale(0);opacity:0;transition:.3s ease';
  setTimeout(() => { renderFavView(); renderFavInProfile(); }, 300);
  showToast('تمت الإزالة');
}

// ==============================
// CHAT SYSTEM
// ==============================
function getChatId(uid1, uid2) {
  return [uid1, uid2].sort().join('_');
}

async function startChat(userId, encodedName, catColor, phone) {
  if (!CU) { showToast('يجب تسجيل الدخول أولاً', 'err'); return; }
  if (userId === CU.id) { showToast('لا يمكنك مراسلة نفسك', 'info'); return; }
  const userName = decodeURIComponent(encodedName);
  curChatUser = { id: userId, name: userName, catColor, phone };
  openConversation(curChatUser);
}

function openConversation(user) {
  // Set header
  const cat = CATS.find(c => c.id === (user.catId || '')) || CATS[0];
  const color = user.catColor || cat.clr;
  const init = (user.name || '؟').split(' ').filter(Boolean).map(w => w[0]).slice(0, 2).join('');
  const cv = document.getElementById('chat-conv');
  const avEl = document.getElementById('cv-av');
  avEl.textContent = init;
  avEl.style.background = `linear-gradient(135deg,${color},${color}aa)`;
  document.getElementById('cv-nm').textContent = user.name || 'مستخدم';
  document.getElementById('cv-status').textContent = TYPE_LABELS[user.type] || '';
  document.getElementById('cv-call').style.display = user.phone ? 'flex' : 'none';
  document.getElementById('cv-wa').style.display = user.phone ? 'flex' : 'none';
  cv.classList.add('on');
  document.getElementById('conv-inp').value = '';
  listenMessages();
}

function closeChat() {
  document.getElementById('chat-conv').classList.remove('on');
  if (chatListener) { chatListener(); chatListener = null; }
  curChatUser = null;
  loadChatList();
}

function convCall() { if (curChatUser?.phone) window.open('tel:' + curChatUser.phone); }
function convWA() { if (curChatUser?.phone) openWA(curChatUser.phone); }

function listenMessages() {
  if (!CU || !curChatUser) return;
  if (chatListener) chatListener();
  const chatId = getChatId(CU.id, curChatUser.id);
  const area = document.getElementById('msgs-area');
  area.innerHTML = `<div class="sp-wrap"><div class="sp" style="width:28px;height:28px;border-width:2px"></div></div>`;

  chatListener = db.collection('dal_chats').doc(chatId).collection('messages')
    .orderBy('ts', 'asc').onSnapshot(snap => {
      if (snap.empty) {
        area.innerHTML = `<div style="text-align:center;padding:40px 20px;color:var(--T3)"><i class="fas fa-comment-dots" style="font-size:40px;margin-bottom:12px;display:block;opacity:.3"></i>ابدأ المحادثة الآن 👋</div>`;
        return;
      }
      let html = '';
      let lastDate = '';
      snap.docs.forEach(doc => {
        const m = doc.data();
        const isMine = m.senderId === CU.id;
        const d = m.ts?.toDate ? m.ts.toDate() : new Date();
        const dateStr = d.toLocaleDateString('ar-IQ', { day: 'numeric', month: 'short' });
        if (dateStr !== lastDate) {
          html += `<div class="msg-date-sep"><span>${dateStr}</span></div>`;
          lastDate = dateStr;
        }
        const timeStr = d.toLocaleTimeString('ar', { hour: '2-digit', minute: '2-digit' });
        const senderInit = isMine ? (CU.name || '؟').split(' ').filter(Boolean).map(w => w[0]).slice(0, 2).join('') : (curChatUser.name || '؟').split(' ').filter(Boolean).map(w => w[0]).slice(0, 2).join('');
        const avColor = isMine ? 'var(--P)' : (curChatUser.catColor || '#64748b');
        html += `<div class="msg-row ${isMine ? 'mine' : 'other'}">
          <div class="msg-av-sm" style="background:${avColor}">${senderInit}</div>
          <div class="msg-bubble">
            ${m.image ? `<img class="msg-img" src="${m.image}" onclick="window.open('${m.image}','_blank')">` : ''}
            ${m.text ? `<div class="msg-txt">${m.text}</div>` : ''}
            <div class="msg-time">${timeStr}${isMine ? ' ✓✓' : ''}</div>
          </div>
        </div>`;
      });
      area.innerHTML = html;
      area.scrollTop = area.scrollHeight;
      // Mark as read
      db.collection('dal_chats').doc(chatId).set({ [`unread_${CU.id}`]: 0 }, { merge: true });
    });
}

async function sendMsg() {
  if (!CU || !curChatUser) return;
  const inp = document.getElementById('conv-inp');
  const text = inp.value.trim();
  if (!text) return;
  inp.value = '';
  const chatId = getChatId(CU.id, curChatUser.id);
  const msgData = { senderId: CU.id, senderName: CU.name, text, ts: FS.serverTimestamp(), type: 'text' };
  try {
    await db.collection('dal_chats').doc(chatId).collection('messages').add(msgData);
    // Update chat meta
    await db.collection('dal_chats').doc(chatId).set({
      participants: [CU.id, curChatUser.id],
      participantNames: { [CU.id]: CU.name || '', [curChatUser.id]: curChatUser.name || '' },
      participantColors: { [CU.id]: CATS.find(c => c.id === CU.catId)?.clr || 'var(--P)', [curChatUser.id]: curChatUser.catColor || '#64748b' },
      lastMsg: text, lastMsgTs: FS.serverTimestamp(),
      [`unread_${curChatUser.id}`]: FS.increment(1),
      [`unread_${CU.id}`]: 0,
    }, { merge: true });
  } catch (e) { showToast('تعذر الإرسال', 'err'); inp.value = text; }
}

async function sendChatImg(e) {
  if (!e.target.files[0] || !CU || !curChatUser) return;
  const file = e.target.files[0];
  e.target.value = '';
  showToast('جاري رفع الصورة...', 'info');
  try {
    const ref = storage.ref(`chats/${CU.id}/${Date.now()}_${file.name}`);
    const snap = await ref.put(file);
    const url = await snap.ref.getDownloadURL();
    const chatId = getChatId(CU.id, curChatUser.id);
    await db.collection('dal_chats').doc(chatId).collection('messages').add({
      senderId: CU.id, senderName: CU.name, image: url, text: '', ts: FS.serverTimestamp(), type: 'image'
    });
    await db.collection('dal_chats').doc(chatId).set({
      participants: [CU.id, curChatUser.id],
      participantNames: { [CU.id]: CU.name || '', [curChatUser.id]: curChatUser.name || '' },
      participantColors: { [CU.id]: CATS.find(c => c.id === CU.catId)?.clr || 'var(--P)', [curChatUser.id]: curChatUser.catColor || '#64748b' },
      lastMsg: '📷 صورة', lastMsgTs: FS.serverTimestamp(),
      [`unread_${curChatUser.id}`]: FS.increment(1),
    }, { merge: true });
  } catch (err) { showToast('تعذر رفع الصورة', 'err'); }
}

async function loadChatList() {
  if (!CU) return;
  const wrap = document.getElementById('chat-list-wrap');
  if (!wrap) return;
  wrap.innerHTML = `<div class="sp-wrap"><div class="sp" style="width:30px;height:30px;border-width:2px"></div></div>`;
  try {
    const snap = await db.collection('dal_chats').where('participants', 'array-contains', CU.id).orderBy('lastMsgTs', 'desc').get();
    if (snap.empty) {
      wrap.innerHTML = `<div class="empty-st"><i class="fas fa-comment-dots"></i><p>لا توجد محادثات بعد</p><span>ابدأ محادثة من ملف أي مستخدم</span></div>`;
      updateChatBadge(0);
      return;
    }
    let totalUnread = 0;
    wrap.innerHTML = snap.docs.map((doc, i) => {
      const d = doc.data();
      const otherId = d.participants.find(p => p !== CU.id) || '';
      const otherName = d.participantNames?.[otherId] || 'مستخدم';
      const otherColor = d.participantColors?.[otherId] || '#64748b';
      const unread = d[`unread_${CU.id}`] || 0;
      totalUnread += unread;
      const init = (otherName).split(' ').filter(Boolean).map(w => w[0]).slice(0, 2).join('');
      const ts = d.lastMsgTs?.toDate ? timeAgo(d.lastMsgTs.toDate()) : '';
      return `<div class="chat-item ${unread > 0 ? 'unread' : ''}" style="animation-delay:${i * .05}s" onclick="openChatById('${otherId}','${encodeURIComponent(otherName)}','${otherColor}')">
        <div class="ci-av" style="background:${otherColor}">${init}</div>
        <div class="ci-txt">
          <div class="ci-nm">${otherName}</div>
          <div class="ci-last">${d.lastMsg || '...'}</div>
        </div>
        <div class="ci-right">
          <div class="ci-time">${ts}</div>
          ${unread > 0 ? `<div class="ci-badge">${unread}</div>` : ''}
        </div>
      </div>`;
    }).join('');
    updateChatBadge(totalUnread);
  } catch (e) {
    wrap.innerHTML = `<div class="empty-st"><i class="fas fa-wifi-slash"></i><p>تعذر التحميل</p></div>`;
  }
}

async function openChatById(userId, encodedName, catColor) {
  const userName = decodeURIComponent(encodedName);
  curChatUser = { id: userId, name: userName, catColor };
  // Try to fetch user info
  try {
    const doc = await db.collection('dal_users').doc(userId).get();
    if (doc.exists) { const d = doc.data(); curChatUser = { ...curChatUser, phone: d.phone, type: d.type }; }
  } catch (e) {}
  openConversation(curChatUser);
}

function updateChatBadge(count) {
  chatUnread = count;
  const bdg = document.getElementById('hchat-bdg');
  const navBdg = document.getElementById('nav-chat-bdg');
  if (bdg) { bdg.textContent = count; bdg.style.display = count > 0 ? 'flex' : 'none'; }
  if (navBdg) { navBdg.textContent = count; navBdg.classList.toggle('on', count > 0); }
}

// ==============================
// SEARCH
// ==============================
function openSrch() { document.getElementById('srch-ov').classList.add('on'); setTimeout(() => document.getElementById('si').focus(), 150); }
function closeSrch() { document.getElementById('srch-ov').classList.remove('on'); document.getElementById('si').value = ''; document.getElementById('sr').innerHTML = `<div style="text-align:center;padding:50px 20px;color:var(--T3)"><i class="fas fa-search" style="font-size:36px;margin-bottom:12px;display:block;opacity:.4"></i>ابحث عن اسم أو خدمة أو مستخدم</div>`; }
function setSrchTab(tab, btn) { srchTab = tab; document.querySelectorAll('.srch-tab').forEach(b => b.classList.remove('on')); btn.classList.add('on'); const q = document.getElementById('si').value; if (q.length >= 2) doSrch(q); }

let srchTmr;
function doSrch(q) {
  clearTimeout(srchTmr);
  const res = document.getElementById('sr');
  if (q.length < 1) { res.innerHTML = `<div style="text-align:center;padding:50px 20px;color:var(--T3)"><i class="fas fa-search" style="font-size:36px;margin-bottom:12px;display:block;opacity:.4"></i>ابحث عن اسم أو خدمة أو مستخدم</div>`; return; }
  res.innerHTML = `<div class="sp-wrap"><div class="sp" style="width:32px;height:32px;border-width:2px"></div></div>`;
  srchTmr = setTimeout(async () => {
    const ql = q.toLowerCase();
    const results = [];
    try {
      if (srchTab === 'all' || srchTab === 'users') {
        const snap = await db.collection('dal_users').get();
        snap.docs.forEach(d => {
          const u = { id: d.id, ...d.data() };
          if ((u.name || '').toLowerCase().includes(ql) || (u.address || '').toLowerCase().includes(ql) || (u.bio || '').toLowerCase().includes(ql) || (TYPE_LABELS[u.type] || '').includes(q)) {
            const cat = CATS.find(c => c.id === u.catId) || CATS[0];
            const init = (u.name || '؟').split(' ').filter(Boolean).map(w => w[0]).slice(0, 2).join('');
            results.push({
              type: 'user',
              html: `<div class="srchitem" onclick="closeSrch();openUserProfile('${u.id}')"><div class="srchico" style="background:${cat.clr}">${init}</div><div class="srchtxt"><div class="srchnm">${highlightText(u.name || '—', q)}</div><div class="srchcat">${cat.lbl} • ${u.address || ''}</div></div><i class="fas fa-chevron-left" style="color:var(--T3);font-size:12px"></i></div>`
            });
          }
        });
      }
      if (srchTab === 'all' || srchTab === 'posts') {
        const snap = await db.collection('dal_posts').orderBy('createdAt', 'desc').limit(50).get();
        snap.docs.forEach(d => {
          const p = { id: d.id, ...d.data() };
          if ((p.title || '').toLowerCase().includes(ql) || (p.description || '').toLowerCase().includes(ql) || (p.address || '').toLowerCase().includes(ql)) {
            const cat = CATS.find(c => c.id === p.catId) || CATS[0];
            results.push({
              type: 'post',
              html: `<div class="srchitem" onclick="closeSrch();showView('feed');setTimeout(()=>{const el=document.getElementById('pcard-${p.id}');if(el)el.scrollIntoView({behavior:'smooth',block:'center'})},500)"><div class="srchico" style="background:${cat.clr}"><i class="fas ${cat.ico}"></i></div><div class="srchtxt"><div class="srchnm">${highlightText(p.title || '—', q)}</div><div class="srchcat">${cat.lbl} • ${p.address || ''}</div></div><i class="fas fa-chevron-left" style="color:var(--T3);font-size:12px"></i></div>`
            });
          }
        });
      }
    } catch (e) {}
    if (!results.length) { res.innerHTML = `<div class="empty-st"><i class="fas fa-search"></i><p>لا توجد نتائج لـ "${q}"</p><span>جرب كلمات بحث مختلفة</span></div>`; return; }
    res.innerHTML = `<div style="font-size:12px;color:var(--T3);font-weight:700;margin-bottom:10px">${results.length} نتيجة</div>` + results.map(r => r.html).join('');
  }, 400);
}

function highlightText(text, q) {
  const idx = text.toLowerCase().indexOf(q.toLowerCase());
  if (idx < 0) return text;
  return text.slice(0, idx) + `<span style="background:#FFD93D;color:var(--T);border-radius:3px;padding:0 2px">${text.slice(idx, idx + q.length)}</span>` + text.slice(idx + q.length);
}

// ==============================
// ADS
// ==============================
const ADS = [
  { icon: '🏢', bg: 'linear-gradient(135deg,#667eea,#764ba2)', sponsor: 'شركة الإبداع الرقمي', title: 'طوّر أعمالك رقمياً!', text: 'نبني تطبيقات الهاتف والمواقع بجودة عالية. تواصل معنا اليوم!', cta: 'تواصل معنا', link: 'https://wa.me/9647801234567', sec: 5 },
  { icon: '📱', bg: 'linear-gradient(135deg,#f093fb,#f5576c)', sponsor: 'دليل الخدمات', title: 'أعلن خدمتك معنا!', text: 'وصول لآلاف العملاء يومياً. أضف خدمتك في دليل الخدمات!', cta: 'أضف إعلانك', link: 'https://wa.me/9647801234567', sec: 5 },
  { icon: '⚡', bg: 'linear-gradient(135deg,#4facfe,#00f2fe)', sponsor: 'خدمات رقمية', title: 'حلول تقنية متكاملة', text: 'أنظمة محاسبة، إدارة مخازن، نقاط بيع، وتطبيقات هاتف.', cta: 'اعرف المزيد', link: 'https://wa.me/9647801234567', sec: 5 },
];
let adIdx = 0;
function showAd() {
  const ad = ADS[adIdx % ADS.length]; adIdx++;
  const overlay = document.getElementById('ad-ov');
  const cnt = document.getElementById('ad-cnt');
  const adX = document.getElementById('ad-x');
  const tfill = document.getElementById('atf');
  cnt.innerHTML = `<div class="adph" style="background:${ad.bg}">${ad.icon}</div><div class="adbody"><div class="adspons">${ad.sponsor}</div><div class="adtit">${ad.title}</div><div class="adtxt">${ad.text}</div><div class="adcta"><a href="${ad.link}" target="_blank" class="adbtn"><i class="fas fa-external-link-alt"></i>${ad.cta}</a><button class="adskip" id="adskip" disabled onclick="closeAd()">إغلاق (<span id="adsec">${ad.sec}</span>)</button></div></div>`;
  adX.disabled = true;
  overlay.classList.add('on');
  tfill.style.transition = `width ${ad.sec}s linear`;
  tfill.style.width = '0%';
  setTimeout(() => tfill.style.width = '100%', 50);
  let s = ad.sec;
  const t = setInterval(() => { s--; const sel = document.getElementById('adsec'); if (sel) sel.textContent = s; if (s <= 0) { clearInterval(t); adX.disabled = false; const sk = document.getElementById('adskip'); if (sk) { sk.disabled = false; sk.textContent = 'إغلاق'; } } }, 1000);
}
function closeAd() { document.getElementById('ad-ov').classList.remove('on'); setTimeout(showAd, 120000); }

// ==============================
// UTILS
// ==============================
function hashPw(pw) { let h = 0; for (let i = 0; i < pw.length; i++) { h = ((h << 5) - h) + pw.charCodeAt(i); h |= 0; } return 'H' + Math.abs(h).toString(36) + pw.length; }
function setFE(id, msg) { const el = document.getElementById(id); if (!el) return; el.classList.add('on'); el.querySelector('span').textContent = msg; }
function clrFE(id) { const el = document.getElementById(id); if (el) el.classList.remove('on'); }
function setLd(btn, ld, txt = '') { if (ld) { btn.classList.add('ld'); btn.innerHTML = `<div style="width:20px;height:20px;border:2px solid rgba(255,255,255,.4);border-top-color:white;border-radius:50%;animation:spin .8s linear infinite"></div><span>${txt || 'جاري...'}</span>`; } else btn.classList.remove('ld'); }
function togglePw(id, btn) { const inp = document.getElementById(id); const isT = inp.type === 'text'; inp.type = isT ? 'password' : 'text'; btn.querySelector('i').className = isT ? 'far fa-eye' : 'far fa-eye-slash'; }
function chkPw(pw) {
  const bars = [1, 2, 3, 4].map(i => document.getElementById('pb' + i));
  const lbl = document.getElementById('pw-l');
  let score = 0;
  if (pw.length >= 6) score++; if (pw.length >= 10) score++; if (/[A-Z]/.test(pw) && /[0-9]/.test(pw)) score++; if (/[^a-zA-Z0-9]/.test(pw)) score++;
  const cls = ['', 'w', 'm', 'm', 's'];
  const lbls = ['أدخل كلمة المرور', 'ضعيفة 🔴', 'متوسطة 🟡', 'جيدة 🟡', 'قوية 🟢'];
  bars.forEach((b, i) => { if (b) b.className = 'pb' + (i < score ? ' ' + cls[score] : ''); });
  if (lbl) lbl.textContent = lbls[score] || '';
}
function tglT() { document.getElementById('trw').classList.toggle('ck'); }
function openTerms() { document.getElementById('tmod').classList.add('on'); }
function closeTerms() { document.getElementById('tmod').classList.remove('on'); }
function acceptTerms() { document.getElementById('trw').classList.add('ck'); closeTerms(); showToast('✓ تمت الموافقة على الشروط', 'ok'); }
function openWA(ph) { let p = String(ph).replace(/\D/g, ''); if (p.startsWith('0')) p = '964' + p.slice(1); window.open(`https://wa.me/${p}`, '_blank'); }

let toastT;
function showToast(msg, type = '') { const t = document.getElementById('toast'); clearTimeout(toastT); t.textContent = msg; t.className = `on${type ? ' ' + type : ''}`; toastT = setTimeout(() => t.className = '', 3200); }
function shareApp() { if (navigator.share) navigator.share({ title: 'دليل الخدمات', url: location.href }); else navigator.clipboard.writeText(location.href).then(() => showToast('تم نسخ الرابط')); }

// PWA
window.addEventListener('beforeinstallprompt', e => { e.preventDefault(); defInst = e; const p = document.getElementById('pwa'); p.style.display = 'flex'; setTimeout(() => p.classList.add('on'), 100); });
function promptInstall() { if (defInst) { defInst.prompt(); defInst.userChoice.then(r => { if (r.outcome === 'accepted') showToast('تم تثبيت التطبيق ✓', 'ok'); defInst = null; }); } else showToast('افتح القائمة واضغط إضافة للشاشة الرئيسية'); dismissPWA(); }
function dismissPWA() { const p = document.getElementById('pwa'); p.classList.remove('on'); setTimeout(() => p.style.display = 'none', 400); }
window.addEventListener('appinstalled', () => showToast('تم التثبيت بنجاح ✓', 'ok'));
if ('serviceWorker' in navigator) window.addEventListener('load', () => navigator.serviceWorker.register('sw.js').catch(() => {}));
</script>
</body>
</html>
